<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SimPrÃ©stamos â€” Reporte Simulaciones</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root{
  --v:#00e5b0;--v2:#00c49a;--v3:rgba(0,229,176,.08);
  --a:#0f4c81;--a2:#1a6db5;--a3:rgba(15,76,129,.15);
  --bg:#07101e;--bg2:#0c1d30;--bg3:#102038;--bg4:#152844;
  --bd:#1e3a58;--bd2:rgba(30,58,88,.6);
  --tx:#a8c8e8;--wh:#e8f4ff;
  --rd:#ff4d6d;--am:#ffc107;--wa:#25d366;
  --r:14px;--r2:10px;--r3:8px;
  --sh:0 8px 32px rgba(0,0,0,.45);--tr:.2s ease;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--tx);min-height:100vh;overflow-x:hidden;padding-bottom:30px}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 80% 50% at 0% 0%,rgba(0,229,176,.06) 0%,transparent 60%),
             radial-gradient(ellipse 60% 40% at 100% 100%,rgba(15,76,129,.1) 0%,transparent 60%)}
.topbar{position:sticky;top:0;z-index:300;background:rgba(7,16,30,.97);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:10px;padding:0 16px;height:56px}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.05rem;color:var(--v);flex:1}
.logo span{color:var(--wh)}
.logo small{font-size:.65rem;color:var(--tx);font-family:'DM Sans',sans-serif;font-weight:400;display:block;opacity:.7;margin-top:-2px}
.app{position:relative;z-index:1;max-width:960px;margin:0 auto;padding:16px 12px}
.card{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);padding:16px;box-shadow:var(--sh);margin-bottom:14px}
.card-titulo{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:var(--wh);margin-bottom:14px;display:flex;align-items:center;gap:8px}
.card-titulo::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--bd),transparent)}
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.stat-card{background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r2);padding:12px 8px;text-align:center}
.stat-card .st-ico{font-size:1.2rem;margin-bottom:4px}
.stat-card .st-num{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;color:var(--wh);line-height:1}
.stat-card .st-lbl{font-size:.58rem;color:var(--tx);opacity:.65;margin-top:3px;text-transform:uppercase;letter-spacing:.04em}
.search-bar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.search-input{flex:1;min-width:0;background:rgba(255,255,255,.05);border:1px solid var(--bd);border-radius:var(--r3);color:var(--wh);font-family:'DM Sans',sans-serif;font-size:.88rem;padding:10px 13px;outline:none}
.search-input:focus{border-color:var(--v)}
.search-select{background:rgba(255,255,255,.05);border:1px solid var(--bd);border-radius:var(--r3);color:var(--wh);font-family:'DM Sans',sans-serif;font-size:.82rem;padding:10px;outline:none;-webkit-appearance:none}
.search-select option{background:var(--bg3)}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:11px 18px;border-radius:var(--r2);font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:600;border:none;cursor:pointer;transition:all var(--tr);white-space:nowrap;min-height:42px}
.btn:disabled{opacity:.35;cursor:not-allowed}
.btn:active:not(:disabled){transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--v),var(--v2));color:var(--bg)}
.btn-primary:hover:not(:disabled){box-shadow:0 6px 20px rgba(0,229,176,.3)}
.btn-azul{background:linear-gradient(135deg,var(--a),var(--a2));color:#fff}
.btn-azul:hover:not(:disabled){box-shadow:0 6px 20px rgba(15,76,129,.35)}
.btn-wa{background:linear-gradient(135deg,#25d366,#1ebe5d);color:#fff}
.btn-wa:hover:not(:disabled){box-shadow:0 6px 20px rgba(37,211,102,.35)}
.btn-ghost{background:rgba(255,255,255,.06);border:1px solid var(--bd);color:var(--tx)}
.btn-ghost:hover:not(:disabled){background:rgba(255,255,255,.1);color:var(--wh)}
.btn-rojo{background:rgba(255,77,109,.15);border:1px solid rgba(255,77,109,.3);color:var(--rd)}
.btn-sm{padding:8px 13px;font-size:.78rem;min-height:36px}
.btn-full{width:100%}
.fila-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
/* TABLA */
.tabla-wrap{overflow-x:auto;border-radius:var(--r2);border:1px solid var(--bd);margin-bottom:14px}
table{width:100%;border-collapse:collapse;min-width:700px}
thead tr{background:var(--a);position:sticky;top:0;z-index:2}
thead th{padding:10px 12px;text-align:left;font-family:'Syne',sans-serif;font-size:.68rem;font-weight:700;color:rgba(255,255,255,.85);text-transform:uppercase;letter-spacing:.05em;white-space:nowrap}
thead th:first-child{width:46px;text-align:center}
tbody tr{border-bottom:1px solid var(--bd2);transition:background var(--tr)}
tbody tr:last-child{border-bottom:none}
tbody tr.sel{background:rgba(0,229,176,.08)!important}
tbody tr.sel td.td-cb{border-left:3px solid var(--v)}
tbody td{padding:9px 12px;font-size:.83rem;color:var(--tx);white-space:nowrap}
tbody td.td-cb{text-align:center;cursor:default}
tbody td.td-row{cursor:pointer}
tbody td.td-row:hover{color:var(--wh)}
tbody tr:hover td.td-row{background:rgba(0,229,176,.03)}
tbody td.nombre{color:var(--wh);font-weight:600}
tbody td.verde{color:var(--v);font-weight:700}
tbody td.amarillo{color:var(--am);font-weight:700}
.cb{width:18px;height:18px;accent-color:var(--v);cursor:pointer}
.badge{display:inline-flex;align-items:center;gap:3px;font-size:.67rem;font-weight:700;padding:3px 8px;border-radius:20px;white-space:nowrap}
.badge-ok{background:rgba(0,229,176,.12);border:1px solid rgba(0,229,176,.28);color:var(--v)}
.badge-p{background:rgba(255,193,7,.12);border:1px solid rgba(255,193,7,.3);color:var(--am)}
.badge-rd{background:rgba(255,77,109,.12);border:1px solid rgba(255,77,109,.3);color:var(--rd)}
.resumen-bar{background:var(--a3);border:1px solid rgba(26,109,181,.3);border-radius:var(--r2);padding:12px 16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;margin-bottom:14px}
.resumen-bar .rb-item{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:70px}
.resumen-bar .rb-val{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;color:var(--wh)}
.resumen-bar .rb-lbl{font-size:.6rem;color:var(--tx);opacity:.65;text-transform:uppercase;letter-spacing:.05em}
.resumen-bar .rb-sep{width:1px;height:36px;background:var(--bd);margin:0 4px}
.wa-panel{background:rgba(37,211,102,.06);border:1px solid rgba(37,211,102,.2);border-radius:var(--r2);padding:16px}
.wa-titulo{font-size:.78rem;font-weight:700;color:var(--wa);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.campo{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.campo label{font-size:.7rem;font-weight:700;color:var(--v);text-transform:uppercase;letter-spacing:.07em}
.campo input,.campo textarea{background:rgba(255,255,255,.05);border:1px solid var(--bd);border-radius:var(--r3);color:var(--wh);font-family:'DM Sans',sans-serif;font-size:.92rem;padding:10px 12px;outline:none;width:100%;transition:border-color var(--tr)}
.campo input:focus,.campo textarea:focus{border-color:var(--v)}
.campo textarea{resize:vertical;min-height:100px;font-size:.82rem;line-height:1.5}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.empty{text-align:center;padding:40px 20px;color:var(--tx);opacity:.4}
.empty .ico{font-size:2.4rem;margin-bottom:10px}
.empty p{font-size:.88rem}
#toast-container{position:fixed;bottom:24px;right:12px;z-index:9999;display:flex;flex-direction:column;gap:7px}
.toast{background:var(--bg4);border:1px solid var(--bd);border-radius:var(--r2);padding:11px 14px;display:flex;align-items:center;gap:9px;animation:toastIn .28s ease;box-shadow:0 8px 28px rgba(0,0,0,.5);font-size:.84rem}
.toast.ok{border-left:3px solid var(--v)}.toast.err{border-left:3px solid var(--rd)}.toast.inf{border-left:3px solid var(--am)}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:18px;height:18px;border:2px solid rgba(255,255,255,.15);border-top-color:var(--v);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto}
.sep{height:1px;background:var(--bd);margin:14px 0}
.alerta{border-radius:var(--r2);padding:10px 13px;font-size:.81rem;display:flex;align-items:flex-start;gap:9px;margin-bottom:12px}
.alerta-info{background:rgba(26,109,181,.1);border:1px solid rgba(26,109,181,.25);color:#7ab8f5}
.alerta-ok{background:rgba(0,229,176,.08);border:1px solid rgba(0,229,176,.22);color:var(--v)}
.sel-bar{display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap}
.sel-bar span{font-size:.78rem;color:var(--tx)}

/* â•â• MODAL â•â• */
.modal-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.8);backdrop-filter:blur(8px);
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .25s ease}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--bg3);border:1px solid var(--bd);border-radius:22px 22px 0 0;
  width:100%;max-width:640px;max-height:92dvh;
  display:flex;flex-direction:column;
  transform:translateY(100%);transition:transform .3s cubic-bezier(.32,.72,0,1);overflow:hidden}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-handle{width:40px;height:4px;background:var(--bd);border-radius:2px;margin:12px auto 0;flex-shrink:0}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;border-bottom:1px solid var(--bd);flex-shrink:0}
.modal-header h2{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--wh)}
.btn-cerrar{background:rgba(255,255,255,.08);border:none;color:var(--tx);font-size:1rem;cursor:pointer;padding:6px 10px;border-radius:8px;transition:all var(--tr);line-height:1}
.btn-cerrar:hover{color:var(--wh);background:rgba(255,255,255,.15)}
.modal-body{overflow-y:auto;padding:16px 18px 8px;flex:1;-webkit-overflow-scrolling:touch}
.modal-footer{padding:14px 18px;border-top:1px solid var(--bd);flex-shrink:0;background:var(--bg3);
  padding-bottom:calc(14px + env(safe-area-inset-bottom))}
.monto-grande{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;color:var(--v);text-align:center;margin:8px 0 4px}
.monto-sub{font-size:.72rem;color:var(--tx);text-align:center;opacity:.65;margin-bottom:14px}
.monto-chips{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.monto-chip{background:var(--a3);border:1px solid rgba(26,109,181,.25);border-radius:var(--r2);padding:10px;text-align:center}
.monto-chip .mc-val{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--wh)}
.monto-chip .mc-lbl{font-size:.62rem;color:var(--tx);opacity:.65;text-transform:uppercase;letter-spacing:.04em;margin-top:3px}
.info-seccion{font-size:.68rem;font-weight:700;color:var(--v);text-transform:uppercase;letter-spacing:.07em;margin:14px 0 8px;display:flex;align-items:center;gap:6px}
.info-seccion::after{content:'';flex:1;height:1px;background:linear-gradient(to right,rgba(0,229,176,.2),transparent)}
.info-box{background:var(--v3);border:1px solid rgba(0,229,176,.12);border-radius:var(--r2);padding:10px 14px;margin-bottom:10px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:.84rem;border-bottom:1px solid rgba(255,255,255,.04)}
.info-row:last-child{border:none;padding-bottom:0}
.info-row .ik{color:var(--tx);opacity:.7;font-size:.76rem;flex-shrink:0}
.info-row .iv{color:var(--wh);font-weight:600;text-align:right;max-width:65%;font-size:.84rem}
.calc-box{background:var(--a3);border:1px solid rgba(26,109,181,.22);border-radius:var(--r2);padding:12px 14px}
.calc-row{display:flex;justify-content:space-between;padding:5px 0;font-size:.84rem;border-bottom:1px solid rgba(255,255,255,.04)}
.calc-row:last-child{border:none;padding-bottom:0}
.calc-row .ck{color:var(--tx);opacity:.7;font-size:.76rem}
.calc-row .cv{color:var(--v);font-weight:700}
.id-tag{font-size:.67rem;background:rgba(0,229,176,.1);border:1px solid rgba(0,229,176,.2);color:var(--v);border-radius:6px;padding:2px 7px;display:inline-block;font-family:'DM Sans',sans-serif;font-weight:600}
/* FOTOS */
.foto-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.foto-card{background:var(--bg4);border:1px solid var(--bd);border-radius:var(--r2);overflow:hidden;text-decoration:none;display:block;transition:border-color var(--tr)}
.foto-card:hover{border-color:var(--v)}
.foto-img{width:100%;height:110px;object-fit:cover;display:block}
.foto-lbl{font-size:.72rem;font-weight:700;color:var(--v);padding:8px 10px;text-align:center;background:var(--bg3)}
.foto-ph{height:110px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;background:var(--bg4);color:var(--tx);opacity:.35}
.foto-ph .ico{font-size:1.8rem}
.foto-ph span{font-size:.72rem}
.mapa-btn{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px;background:var(--a3);border:1px solid rgba(26,109,181,.3);border-radius:var(--r2);color:#7ab8f5;font-weight:600;font-size:.88rem;text-decoration:none;transition:all var(--tr);margin-bottom:10px}
.mapa-btn:hover{background:rgba(26,109,181,.25)}
@media(min-width:600px){
  .app{max-width:960px}
  .modal{border-radius:16px;margin:20px;max-height:88vh}
  .modal-overlay{align-items:center}
  .modal-handle{display:none}
}
</style>
</head>
<body>

<div class="topbar">
  <div class="logo">Sim<span>PrÃ©stamos</span><small>Consulta General de Simulaciones</small></div>
  <button class="btn btn-ghost btn-sm" onclick="history.back()">â† Volver</button>
</div>

<div class="app">
  <div class="stats-row">
    <div class="stat-card"><div class="st-ico">ğŸ“Š</div><div class="st-num" id="st-total">â€”</div><div class="st-lbl">Total</div></div>
    <div class="stat-card"><div class="st-ico">â˜‘ï¸</div><div class="st-num" id="st-sel">0</div><div class="st-lbl">Selec.</div></div>
    <div class="stat-card"><div class="st-ico">ğŸ’µ</div><div class="st-num" id="st-capital">â€”</div><div class="st-lbl">Capital sel.</div></div>
    <div class="stat-card"><div class="st-ico">ğŸ’°</div><div class="st-num" id="st-total-sel">â€”</div><div class="st-lbl">Total sel.</div></div>
  </div>

  <div class="card">
    <div class="card-titulo">ğŸ“‹ Simulaciones</div>
    <div class="search-bar">
      <input class="search-input" id="filtro" placeholder="ğŸ” Buscar nombre, telÃ©fono, ID..." oninput="filtrar()">
      <select class="search-select" id="filtro-estado" onchange="filtrar()">
        <option value="">Todos</option>
        <option value="Completo">âœ… Completo</option>
        <option value="Nuevo">âš ï¸ Nuevo</option>
        <option value="Pendiente">â³ Pendiente</option>
      </select>
      <button class="btn btn-azul btn-sm" onclick="cargar()">ğŸ”„ Cargar</button>
    </div>
    <div class="sel-bar">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:.82rem;color:var(--wh)">
        <input type="checkbox" class="cb" id="cb-todos" onchange="toggleTodos(this.checked)">
        Seleccionar todos
      </label>
      <span id="sel-count-lbl" style="color:var(--v);font-weight:600"></span>
      <button class="btn btn-ghost btn-sm" onclick="limpiarSel()">âœ• Limpiar</button>
    </div>
    <div class="alerta alerta-info" style="margin-bottom:10px">
      <span>ğŸ’¡</span>
      <div><strong>Click en la fila</strong> â†’ ver detalle completo con fotos y ubicaciÃ³n &nbsp;|&nbsp; <strong>Cuadro â˜‘</strong> â†’ seleccionar para el reporte</div>
    </div>
    <div class="tabla-wrap" id="tabla-wrap">
      <div class="empty"><div class="ico">ğŸ“Š</div><p>Presiona ğŸ”„ Cargar para ver simulaciones</p></div>
    </div>
  </div>

  <div class="resumen-bar" id="resumen-bar" style="display:none">
    <div class="rb-item"><div class="rb-val" id="rb-n">0</div><div class="rb-lbl">Filas sel.</div></div>
    <div class="rb-sep"></div>
    <div class="rb-item"><div class="rb-val" id="rb-cap">$0</div><div class="rb-lbl">Î£ Capital</div></div>
    <div class="rb-sep"></div>
    <div class="rb-item"><div class="rb-val" id="rb-tot">$0</div><div class="rb-lbl">Î£ Total</div></div>
    <div class="rb-sep"></div>
    <div class="rb-item"><div class="rb-val" id="rb-pago">$0</div><div class="rb-lbl">Î£ Pago diario</div></div>
    <div class="rb-sep"></div>
    <div class="rb-item"><div class="rb-val" id="rb-dias">0</div><div class="rb-lbl">DÃ­as prom.</div></div>
  </div>

  <div class="card">
    <div class="card-titulo">ğŸ“¤ Exportar y Enviar</div>
    <div class="alerta alerta-info"><span>â„¹ï¸</span><div>Selecciona filas con â˜‘, descarga el reporte .xlsx y envÃ­alo por WhatsApp.</div></div>
    <div class="g2" style="margin-bottom:12px">
      <div class="campo"><label>ğŸ“„ Nombre del reporte</label><input type="text" id="rep-nombre" value="Reporte_Simulaciones"></div>
      <div class="campo"><label>ğŸ—“ï¸ PerÃ­odo</label><input type="text" id="rep-periodo" placeholder="Ej: Febrero 2026"></div>
    </div>
    <button class="btn btn-primary btn-full" id="btn-exportar" onclick="exportarXLSX()" disabled>â¬‡ï¸ Descargar Reporte .xlsx</button>
    <div class="sep"></div>
    <div class="wa-panel">
      <div class="wa-titulo">ğŸ“± Enviar por WhatsApp</div>
      <div class="alerta alerta-ok" style="margin-bottom:12px"><span>ğŸ’¡</span><div>Primero descarga el archivo, luego compÃ¡rtelo desde tu carpeta de descargas.</div></div>
      <div class="g2">
        <div class="campo"><label>Nombre contacto</label><input type="text" id="wa-nombre" placeholder="Ej: Gerente"></div>
        <div class="campo"><label>TelÃ©fono WhatsApp</label><input type="tel" id="wa-tel" placeholder="4421234567"></div>
      </div>
      <div class="campo"><label>Mensaje</label><textarea id="wa-msg" rows="6"></textarea></div>
      <div class="fila-btns">
        <button class="btn btn-ghost btn-sm" onclick="generarMensaje()">ğŸ”„ Generar</button>
        <button class="btn btn-wa" onclick="enviarWA()" style="flex:1">ğŸ“± Abrir WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DETALLE -->
<div class="modal-overlay" id="modal-det">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2 id="modal-titulo">ğŸ’° SimulaciÃ³n</h2>
      <button class="btn-cerrar" onclick="cerrarModal()">âœ•</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer" id="modal-footer"></div>
  </div>
</div>

<div id="toast-container"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const GAS_URL='https://script.google.com/macros/s/AKfycbw83md07bzx1UmGRn51i-pRiuvQaEig_mUWS4VjvO0yTIlDCULqT8p3NGsSe2S4nZhzjA/exec';
let todasSims=[],simsFiltradas=[],seleccionadas=new Set(),archivoNombre='';

function g(id){return document.getElementById(id)}
function fmt(n){if(n===null||n===undefined||n==='')return'â€”';const num=Number(n);if(isNaN(num))return'â€”';return'$'+num.toLocaleString('es-MX',{minimumFractionDigits:0,maximumFractionDigits:0})}
function fmtFecha(s){if(!s)return'â€”';const d=new Date(s);if(isNaN(d))return String(s).slice(0,16);return d.toLocaleString('es-MX',{dateStyle:'short',timeStyle:'short'})}
function esLink(v){return v&&typeof v==='string'&&v.startsWith('http')&&v!=='No disponible'&&v.length>10}
function badge(e){const m={'Completo':['badge-ok','âœ…'],'Nuevo':['badge-p','âš ï¸'],'Pendiente':['badge-p','â³'],'Activo':['badge-ok','âœ…'],'Inactivo':['badge-rd','âŒ']};const[c,i]=m[e]||['badge-p','â³'];return`<span class="badge ${c}">${i} ${e||'â€”'}</span>`}
function toast(msg,tipo='ok',dur=3500){const c=g('toast-container'),t=document.createElement('div');t.className=`toast ${tipo}`;t.innerHTML=`<span>${tipo==='ok'?'âœ…':tipo==='err'?'âŒ':'â„¹ï¸'}</span><span>${msg}</span>`;c.appendChild(t);setTimeout(()=>t.style.opacity='0',dur-400);setTimeout(()=>t.remove(),dur)}

async function cargar(){
  const wrap=g('tabla-wrap');
  wrap.innerHTML=`<div class="empty"><div class="spinner"></div><p style="margin-top:12px">Conectando...</p></div>`;
  g('st-total').textContent='â€¦';
  try{
    const r=await fetch(`${GAS_URL}?tipo=simulaciones`,{redirect:'follow'});
    const d=await r.json();
    if(d?.success&&d.data?.simulaciones?.length){
      todasSims=d.data.simulaciones.map(s=>({
        id:s[0],idCliente:s[1],fechaHora:s[2],nombre:s[3],telefono:s[4],
        capital:s[5],dias:s[6],interesPorc:s[7],interesTotal:s[8],
        total:s[9],pagoDiario:s[10],latitud:s[11],longitud:s[12],
        ubicacion:s[13],linkMapa:s[14],fotoINE:s[15],fotoComp:s[16],
        estado:String(s[17]||'').replace(/[âœ…âŒâš ï¸]\s*/,''),
        notas:s[18],correo:s[19],
      }));
      toast(`âœ… ${todasSims.length} simulaciones cargadas`,'ok');
    }else{
      const rc=await fetch(`${GAS_URL}?tipo=clientes`,{redirect:'follow'});
      const dc=await rc.json();
      if(dc?.success){
        todasSims=(dc.data?.clientes||[]).map(c=>({
          id:c.idCliente,idCliente:c.idCliente,fechaHora:c.ultimaInteraccion||c.fechaRegistro,
          nombre:c.nombreCliente,telefono:c.telefono,correo:c.correo,ubicacion:c.ubicacion,
          capital:'',dias:'',interesPorc:'',interesTotal:'',total:'',pagoDiario:'',
          linkMapa:'',fotoINE:'',fotoComp:'',
          estado:String(c.estado||'Activo').replace(/[âœ…âŒ]\s*/,''),
          notas:`${c.cantidadSimulaciones||0} simulaciones`,
        }));
        toast(`${todasSims.length} clientes cargados`,'inf',4000);
      }else throw new Error('Sin datos');
    }
  }catch(e){
    wrap.innerHTML=`<div class="empty"><div class="ico">âš ï¸</div><p>Error de conexiÃ³n</p></div>`;
    toast('Error de conexiÃ³n','err');return;
  }
  seleccionadas.clear();g('st-total').textContent=todasSims.length;filtrar();actualizarStats();
}

function filtrar(){
  const q=g('filtro').value.toLowerCase(),est=g('filtro-estado').value;
  simsFiltradas=todasSims.filter(s=>{
    const txt=`${s.id} ${s.nombre} ${s.telefono} ${s.idCliente} ${s.correo}`.toLowerCase();
    return(!q||txt.includes(q))&&(!est||s.estado===est);
  });renderTabla();
}

function renderTabla(){
  const wrap=g('tabla-wrap');
  if(!simsFiltradas.length){wrap.innerHTML=`<div class="empty"><div class="ico">ğŸ“­</div><p>Sin resultados</p></div>`;return;}
  const filas=simsFiltradas.map(s=>{
    const chk=seleccionadas.has(s.id)?'checked':'',selCls=seleccionadas.has(s.id)?'sel':'';
    const iconos=(esLink(s.fotoINE)||esLink(s.fotoComp)?'<span style="font-size:.62rem;opacity:.55;margin-left:3px">ğŸ“</span>':'')+(esLink(s.linkMapa)?'<span style="font-size:.62rem;opacity:.55">ğŸ“</span>':'');
    return`<tr class="${selCls}" id="tr-${s.id}">
      <td class="td-cb"><input type="checkbox" class="cb" id="cb-${s.id}" ${chk} onchange="toggleFila('${s.id}',event)" onclick="event.stopPropagation()"></td>
      <td class="td-row nombre" onclick="abrirDetalle('${s.id}')">${s.nombre||'â€”'}${iconos}</td>
      <td class="td-row" onclick="abrirDetalle('${s.id}')">${s.telefono||'â€”'}</td>
      <td class="td-row" onclick="abrirDetalle('${s.id}')" style="font-size:.75rem;color:var(--tx)">${fmtFecha(s.fechaHora)}</td>
      <td class="td-row verde" onclick="abrirDetalle('${s.id}')">${s.capital?fmt(s.capital):'â€”'}</td>
      <td class="td-row" onclick="abrirDetalle('${s.id}')">${s.dias?s.dias+'d':'â€”'}</td>
      <td class="td-row" onclick="abrirDetalle('${s.id}')">${s.interesPorc?s.interesPorc+'%':'â€”'}</td>
      <td class="td-row amarillo" onclick="abrirDetalle('${s.id}')">${s.pagoDiario?fmt(s.pagoDiario):'â€”'}</td>
      <td class="td-row verde" onclick="abrirDetalle('${s.id}')" style="font-size:.88rem">${s.total?fmt(s.total):'â€”'}</td>
      <td class="td-row" onclick="abrirDetalle('${s.id}')">${badge(s.estado)}</td>
      <td class="td-row" onclick="abrirDetalle('${s.id}')" style="font-size:.73rem;max-width:120px;overflow:hidden;text-overflow:ellipsis">${s.notas||'â€”'}</td>
    </tr>`;
  }).join('');
  wrap.innerHTML=`<table>
    <thead><tr><th>â˜‘</th><th>Nombre</th><th>TelÃ©fono</th><th>Fecha</th><th>Capital</th><th>DÃ­as</th><th>Int%</th><th>Pago/dÃ­a</th><th>Total</th><th>Estado</th><th>Notas</th></tr></thead>
    <tbody>${filas}</tbody></table>`;
  actualizarStats();
}

function toggleFila(id,e){
  if(e){e.stopPropagation();}
  if(seleccionadas.has(id))seleccionadas.delete(id);else seleccionadas.add(id);
  const tr=g(`tr-${id}`),cb=g(`cb-${id}`);
  if(tr)tr.classList.toggle('sel',seleccionadas.has(id));
  if(cb)cb.checked=seleccionadas.has(id);
  actualizarStats();
}
function toggleTodos(checked){simsFiltradas.forEach(s=>{if(checked)seleccionadas.add(s.id);else seleccionadas.delete(s.id)});renderTabla();g('cb-todos').checked=checked;}
function limpiarSel(){seleccionadas.clear();g('cb-todos').checked=false;renderTabla();}
function getSeleccionadas(){return todasSims.filter(s=>seleccionadas.has(s.id));}

function actualizarStats(){
  const sel=getSeleccionadas(),n=sel.length;
  const sumCap=sel.reduce((a,s)=>a+(Number(s.capital)||0),0);
  const sumTot=sel.reduce((a,s)=>a+(Number(s.total)||0),0);
  const sumPago=sel.reduce((a,s)=>a+(Number(s.pagoDiario)||0),0);
  const promDias=n?Math.round(sel.reduce((a,s)=>a+(Number(s.dias)||0),0)/n):0;
  g('st-sel').textContent=n;g('st-capital').textContent=n?fmt(sumCap):'â€”';g('st-total-sel').textContent=n?fmt(sumTot):'â€”';
  g('sel-count-lbl').textContent=n?`${n} fila${n>1?'s':''} seleccionada${n>1?'s':''}` :'';
  const rb=g('resumen-bar');
  if(n>0){rb.style.display='flex';g('rb-n').textContent=n;g('rb-cap').textContent=fmt(sumCap);g('rb-tot').textContent=fmt(sumTot);g('rb-pago').textContent=fmt(sumPago);g('rb-dias').textContent=promDias+'d';}
  else rb.style.display='none';
  g('btn-exportar').disabled=n===0;generarMensaje();
}

// â•â• MODAL DETALLE â•â•
function abrirDetalle(id){
  const s=todasSims.find(x=>x.id===id);if(!s)return;

  g('modal-titulo').textContent=`ğŸ’° ${s.nombre||'SimulaciÃ³n'}`;

  // fotos
  let fotosHTML='';
  if(esLink(s.fotoINE)||esLink(s.fotoComp)){
    fotosHTML=`<div class="info-seccion">ğŸ“ Documentos</div>
    <div class="foto-grid">
      ${esLink(s.fotoINE)
        ?`<a class="foto-card" href="${s.fotoINE}" target="_blank">
            <img class="foto-img" src="${s.fotoINE}" alt="INE" onerror="this.parentNode.querySelector('.foto-ph').style.display='flex';this.style.display='none'">
            <div class="foto-ph" style="display:none"><div class="ico">ğŸªª</div><span>Abrir en Drive</span></div>
            <div class="foto-lbl">ğŸªª Ver INE</div></a>`
        :`<div class="foto-card"><div class="foto-ph"><div class="ico">ğŸªª</div><span>Sin INE</span></div><div class="foto-lbl" style="color:var(--tx);opacity:.35">No disponible</div></div>`
      }
      ${esLink(s.fotoComp)
        ?`<a class="foto-card" href="${s.fotoComp}" target="_blank">
            <img class="foto-img" src="${s.fotoComp}" alt="Comp" onerror="this.parentNode.querySelector('.foto-ph').style.display='flex';this.style.display='none'">
            <div class="foto-ph" style="display:none"><div class="ico">ğŸ </div><span>Abrir en Drive</span></div>
            <div class="foto-lbl">ğŸ  Ver Comprobante</div></a>`
        :`<div class="foto-card"><div class="foto-ph"><div class="ico">ğŸ </div><span>Sin comprobante</span></div><div class="foto-lbl" style="color:var(--tx);opacity:.35">No disponible</div></div>`
      }
    </div>`;
  }

  // mapa
  let mapaHTML='';
  if(esLink(s.linkMapa)){
    mapaHTML=`<div class="info-seccion">ğŸ“ UbicaciÃ³n</div>
      <a class="mapa-btn" href="${s.linkMapa}" target="_blank">ğŸ—ºï¸ Ver en Google Maps</a>
      ${s.ubicacion?`<div style="font-size:.76rem;color:var(--tx);opacity:.65;margin-bottom:12px;padding:0 2px">${s.ubicacion}</div>`:''}`;
  }else if(s.ubicacion&&s.ubicacion!=='No disponible'){
    mapaHTML=`<div class="info-seccion">ğŸ“ UbicaciÃ³n</div>
      <div style="font-size:.82rem;color:var(--tx);margin-bottom:12px;padding:8px 12px;background:var(--bg4);border-radius:var(--r3);border:1px solid var(--bd)">${s.ubicacion}</div>`;
  }

  g('modal-body').innerHTML=`
    <div class="monto-grande">${s.total?fmt(s.total):'â€”'}</div>
    <div class="monto-sub">Total a pagar</div>
    <div class="monto-chips">
      <div class="monto-chip"><div class="mc-val" style="color:var(--v)">${s.capital?fmt(s.capital):'â€”'}</div><div class="mc-lbl">Capital</div></div>
      <div class="monto-chip"><div class="mc-val" style="color:var(--am)">${s.pagoDiario?fmt(s.pagoDiario):'â€”'}</div><div class="mc-lbl">Pago diario</div></div>
      <div class="monto-chip"><div class="mc-val">${s.dias?s.dias+' dÃ­as':'â€”'}</div><div class="mc-lbl">Plazo</div></div>
      <div class="monto-chip"><div class="mc-val">${s.interesPorc?s.interesPorc+'%':'â€”'}</div><div class="mc-lbl">InterÃ©s</div></div>
    </div>
    <div class="sep" style="margin:6px 0 0"></div>
    <div class="info-seccion">ğŸ‘¤ Cliente</div>
    <div class="info-box">
      <div class="info-row"><span class="ik">ğŸ†” ID Sim</span><span class="iv"><span class="id-tag">${s.id}</span></span></div>
      <div class="info-row"><span class="ik">ğŸ†” ID Cliente</span><span class="iv"><span class="id-tag">${s.idCliente||'â€”'}</span></span></div>
      <div class="info-row"><span class="ik">ğŸ‘¤ Nombre</span><span class="iv">${s.nombre||'â€”'}</span></div>
      <div class="info-row"><span class="ik">ğŸ“ TelÃ©fono</span><span class="iv">${s.telefono||'â€”'}</span></div>
      <div class="info-row"><span class="ik">ğŸ“§ Correo</span><span class="iv">${s.correo||'â€”'}</span></div>
      <div class="info-row"><span class="ik">ğŸ“… Fecha</span><span class="iv">${fmtFecha(s.fechaHora)}</span></div>
      <div class="info-row"><span class="ik">ğŸ”” Estado</span><span class="iv">${badge(s.estado)}</span></div>
      ${s.notas?`<div class="info-row"><span class="ik">ğŸ“ Notas</span><span class="iv">${s.notas}</span></div>`:''}
    </div>
    <div class="info-seccion">ğŸ’° CÃ¡lculo</div>
    <div class="calc-box">
      <div class="calc-row"><span class="ck">ğŸ’µ Capital</span><span class="cv">${s.capital?fmt(s.capital):'â€”'}</span></div>
      <div class="calc-row"><span class="ck">ğŸ“… Plazo</span><span class="cv">${s.dias?s.dias+' dÃ­as':'â€”'}</span></div>
      <div class="calc-row"><span class="ck">ğŸ“ˆ InterÃ©s %</span><span class="cv">${s.interesPorc?s.interesPorc+'%':'â€”'}</span></div>
      <div class="calc-row"><span class="ck">ğŸ’¸ InterÃ©s $</span><span class="cv">${s.interesTotal?fmt(s.interesTotal):'â€”'}</span></div>
      <div class="calc-row"><span class="ck">ğŸ—“ï¸ Pago diario</span><span class="cv" style="font-size:1rem">${s.pagoDiario?fmt(s.pagoDiario):'â€”'}</span></div>
      <div class="calc-row"><span class="ck">ğŸ’° Total a pagar</span><span class="cv" style="font-size:1.05rem">${s.total?fmt(s.total):'â€”'}</span></div>
    </div>
    ${mapaHTML}
    ${fotosHTML}
  `;

  const esSel=seleccionadas.has(s.id);
  g('modal-footer').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      <button class="btn btn-wa" onclick="waDesdeDetalle('${s.id}')">ğŸ“± WhatsApp</button>
      <button class="btn ${esSel?'btn-rojo':'btn-primary'}" id="btn-modal-sel" onclick="toggleDesdeModal('${s.id}')">
        ${esSel?'âœ• Quitar del reporte':'â˜‘ Agregar al reporte'}
      </button>
    </div>
    <button class="btn btn-ghost btn-full" onclick="cerrarModal()">Cerrar</button>`;

  g('modal-det').classList.add('open');
}

function cerrarModal(){g('modal-det').classList.remove('open')}

function toggleDesdeModal(id){
  toggleFila(id,null);
  const esSel=seleccionadas.has(id);
  const btn=g('btn-modal-sel');
  if(btn){btn.className=`btn ${esSel?'btn-rojo':'btn-primary'}`;btn.textContent=esSel?'âœ• Quitar del reporte':'â˜‘ Agregar al reporte';}
  toast(esSel?'âœ… Agregado al reporte':'Quitado del reporte',esSel?'ok':'inf');
}

function waDesdeDetalle(id){
  const s=todasSims.find(x=>x.id===id);if(!s)return;
  const tel=String(s.telefono||'').replace(/\D/g,'');
  if(!tel){toast('Sin telÃ©fono','err');return;}
  const n=tel.length===10?'52'+tel:tel;
  const msg=[`ğŸ’° *RESULTADO DE SU SIMULACIÃ“N â€” SimPrÃ©stamos*`,``,
    `Hola *${s.nombre||'Cliente'}*, aquÃ­ el resumen de su cÃ¡lculo:`,``,
    s.capital?`ğŸ’µ *Capital:* ${fmt(s.capital)}`:'',s.dias?`ğŸ“… *Plazo:* ${s.dias} dÃ­as`:'',
    s.interesPorc?`ğŸ“ˆ *InterÃ©s:* ${s.interesPorc}%`:'',s.pagoDiario?`ğŸ—“ï¸ *Pago diario:* ${fmt(s.pagoDiario)}`:'',
    s.total?`ğŸ’¸ *Total:* ${fmt(s.total)}`:'',``,`Â¿Le interesa continuar? Le agendamos una entrevista.`,``,
    `_SimPrÃ©stamos â€” ${new Date().toLocaleDateString('es-MX')}_`].filter(Boolean).join('\n');
  window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`,'_blank');
  toast('ğŸ“± WhatsApp abierto','ok');
}

// Cerrar modal
window.addEventListener('click',e=>{if(e.target===g('modal-det'))cerrarModal()});
const modalEl=document.querySelector('#modal-det .modal');
let startY=0;
modalEl.addEventListener('touchstart',e=>{startY=e.touches[0].clientY},{passive:true});
modalEl.addEventListener('touchend',e=>{if(e.changedTouches[0].clientY-startY>80)cerrarModal()},{passive:true});

function exportarXLSX(){
  const sel=getSeleccionadas();if(!sel.length){toast('Selecciona al menos una fila','err');return;}
  const nombre=(g('rep-nombre').value||'Reporte_Simulaciones').replace(/\s/g,'_');
  const periodo=g('rep-periodo').value||'';archivoNombre=`${nombre}_${new Date().toISOString().slice(0,10)}.xlsx`;
  const cab=['ID Sim','ID Cliente','Nombre Cliente','TelÃ©fono','Correo','Fecha/Hora','Capital ($)','DÃ­as','InterÃ©s (%)','InterÃ©s ($)','Pago Diario ($)','Total ($)','UbicaciÃ³n','Estado','Notas'];
  const filas=sel.map(s=>[s.id,s.idCliente,s.nombre,s.telefono,s.correo,s.fechaHora,Number(s.capital)||'',Number(s.dias)||'',Number(s.interesPorc)||'',Number(s.interesTotal)||'',Number(s.pagoDiario)||'',Number(s.total)||'',s.ubicacion,s.estado,s.notas]);
  const sumCap=sel.reduce((a,s)=>a+(Number(s.capital)||0),0),sumTot=sel.reduce((a,s)=>a+(Number(s.total)||0),0),sumPago=sel.reduce((a,s)=>a+(Number(s.pagoDiario)||0),0);
  const ws=XLSX.utils.aoa_to_sheet([cab,...filas,[],['','','TOTALES','','',`${sel.length} registros`,sumCap,'','','',sumPago,sumTot,'','','']]);
  ws['!cols']=[{wch:14},{wch:14},{wch:22},{wch:14},{wch:24},{wch:18},{wch:12},{wch:7},{wch:10},{wch:12},{wch:14},{wch:12},{wch:28},{wch:11},{wch:24}];
  const ws2=XLSX.utils.aoa_to_sheet([['REPORTE DE SIMULACIONES â€” SimPrÃ©stamos'],[],['Generado',new Date().toLocaleString('es-MX')],['PerÃ­odo',periodo||'â€”'],['Total filas',sel.length],[],['RESUMEN FINANCIERO'],['Suma Capital',sumCap],['Suma Total',sumTot],['Suma Pago Diario',sumPago],['DÃ­as promedio',sel.length?Math.round(sel.reduce((a,s)=>a+(Number(s.dias)||0),0)/sel.length):0]]);
  ws2['!cols']=[{wch:22},{wch:20}];
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Simulaciones');XLSX.utils.book_append_sheet(wb,ws2,'Resumen');
  XLSX.writeFile(wb,archivoNombre);toast(`âœ… ${archivoNombre} descargado`,'ok');generarMensaje();
}

function generarMensaje(){
  const sel=getSeleccionadas(),n=sel.length;
  const nombre=g('wa-nombre')?.value||'',periodo=g('rep-periodo')?.value||'',rep=g('rep-nombre')?.value||'Reporte_Simulaciones';
  const fecha=new Date().toLocaleDateString('es-MX');
  const sumCap=sel.reduce((a,s)=>a+(Number(s.capital)||0),0),sumTot=sel.reduce((a,s)=>a+(Number(s.total)||0),0);
  const msg=[`ğŸ“Š *REPORTE DE SIMULACIONES â€” SimPrÃ©stamos*`,``,nombre?`Hola *${nombre}*, te comparto el reporte generado.`:`Reporte de simulaciones adjunto.`,``,
    `ğŸ“„ *Archivo:* ${rep}_${new Date().toISOString().slice(0,10)}.xlsx`,periodo?`ğŸ—“ï¸ *PerÃ­odo:* ${periodo}`:'',`ğŸ“… *Generado:* ${fecha}`,``,
    `ğŸ“‹ *Resumen:*`,`â€¢ Registros: *${n}*`,n>0?`â€¢ Î£ Capital: *${fmt(sumCap)}*`:'',n>0?`â€¢ Î£ Total:   *${fmt(sumTot)}*`:'',``,
    `â¬‡ï¸ El archivo fue descargado en tu dispositivo.`,`Puedes compartirlo desde tu carpeta de descargas.`,``,`_SimPrÃ©stamos â€” ${fecha}_`
  ].filter(v=>v!==null&&v!==undefined&&v!==false).join('\n');
  const ta=g('wa-msg');if(ta)ta.value=msg;
}
function enviarWA(){
  const tel=g('wa-tel').value.trim(),msg=g('wa-msg').value.trim();
  if(!tel){toast('Ingresa el nÃºmero','err');return;}if(!msg){toast('Mensaje vacÃ­o','err');return;}
  const t=String(tel).replace(/\D/g,''),num=t.length===10?'52'+t:t;
  window.open(`https://wa.me/${num}?text=${encodeURIComponent(msg)}`,'_blank');toast('ğŸ“± WhatsApp abierto','ok');
}
window.addEventListener('load',()=>{
  generarMensaje();
  ['wa-nombre','rep-nombre','rep-periodo'].forEach(id=>{const el=g(id);if(el)el.addEventListener('input',generarMensaje)});
});
</script>
</body>
</html>
