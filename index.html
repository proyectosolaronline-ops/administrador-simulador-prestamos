<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SimPrÃ©stamo â€” Agenda de Entrevistas</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --verde:#00e5b0; --verde2:#00c49a;
  --azul:#0f4c81;  --azul2:#1a6db5;
  --negro:#07101e; --oscuro:#0c1d30;
  --panel:#102038; --panel2:#152844;
  --borde:#1e3a58; --texto:#a8c8e8;
  --blanco:#e8f4ff; --rojo:#ff4d6d;
  --naranja:#ff8c42; --amarillo:#ffc107;
  --wa:#25d366; --radio:12px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'DM Sans',sans-serif;background:var(--negro);color:var(--texto);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 60% 45% at 5% 10%,rgba(0,229,176,.07) 0%,transparent 65%),
             radial-gradient(ellipse 50% 40% at 95% 90%,rgba(15,76,129,.12) 0%,transparent 65%)}

/* TOPBAR */
.topbar{position:sticky;top:0;z-index:200;background:rgba(7,16,30,.96);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--borde);display:flex;align-items:center;gap:12px;padding:0 22px;height:60px}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.18rem;color:var(--verde)}
.logo span{color:var(--blanco)}
.topbar-sub{font-size:.8rem;color:var(--texto);opacity:.6;font-weight:500;flex:1}
.chip{font-size:.72rem;font-weight:700;padding:3px 10px;border-radius:20px;white-space:nowrap}
.chip-wa{background:rgba(37,211,102,.14);border:1px solid rgba(37,211,102,.3);color:var(--wa)}
.chip-ok{background:rgba(0,229,176,.12);border:1px solid rgba(0,229,176,.28);color:var(--verde)}

/* LAYOUT */
.app{position:relative;z-index:1;max-width:1320px;margin:0 auto;padding:22px 18px 80px}

/* URL BAR */
.url-bar{background:rgba(255,140,66,.07);border:1px solid rgba(255,140,66,.22);border-radius:10px;
  padding:11px 16px;margin-bottom:18px;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.url-bar label{font-size:.78rem;font-weight:700;color:var(--naranja);white-space:nowrap}
.url-bar input{flex:1;min-width:200px;background:rgba(255,255,255,.05);border:1px solid rgba(255,140,66,.28);
  border-radius:8px;color:var(--blanco);font-family:'DM Sans',sans-serif;font-size:.84rem;padding:7px 11px;outline:none}
.url-bar input:focus{border-color:var(--naranja)}
.url-bar small{font-size:.72rem;color:var(--texto);opacity:.6}

/* TABS */
.tabs{display:flex;gap:4px;background:var(--oscuro);border:1px solid var(--borde);border-radius:12px;
  padding:5px;margin-bottom:22px;flex-wrap:wrap}
.tab-btn{flex:1;min-width:120px;padding:9px 14px;border:none;border-radius:9px;background:transparent;
  color:var(--texto);font-family:'DM Sans',sans-serif;font-size:.84rem;font-weight:500;cursor:pointer;
  transition:all .22s;display:flex;align-items:center;justify-content:center;gap:7px}
.tab-btn:hover{background:rgba(255,255,255,.05);color:var(--blanco)}
.tab-btn.activo{background:linear-gradient(135deg,var(--azul),var(--azul2));color:#fff;font-weight:600;
  box-shadow:0 4px 16px rgba(15,76,129,.38)}

/* SECCIONES */
.seccion{display:none;animation:fadeUp .3s ease both}
.seccion.visible{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}

/* CARDS */
.card{background:var(--panel);border:1px solid var(--borde);border-radius:var(--radio);padding:22px;
  box-shadow:0 6px 32px rgba(0,0,0,.4);margin-bottom:18px}
.card-titulo{font-family:'Syne',sans-serif;font-size:1.04rem;font-weight:700;color:var(--blanco);
  margin-bottom:18px;display:flex;align-items:center;gap:8px}
.card-titulo::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--borde),transparent)}

/* GRIDS */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
@media(max-width:860px){.g3,.g4{grid-template-columns:1fr 1fr}}
@media(max-width:580px){.g2,.g3,.g4{grid-template-columns:1fr}}

/* CAMPOS */
.campo{display:flex;flex-direction:column;gap:5px}
.campo label{font-size:.75rem;font-weight:700;color:var(--verde);text-transform:uppercase;letter-spacing:.07em}
.campo input,.campo select,.campo textarea{background:rgba(255,255,255,.05);border:1px solid var(--borde);
  border-radius:8px;color:var(--blanco);font-family:'DM Sans',sans-serif;font-size:.9rem;padding:9px 12px;outline:none;
  transition:border-color .2s,background .2s}
.campo input:focus,.campo select:focus,.campo textarea:focus{border-color:var(--verde);background:rgba(0,229,176,.05)}
.campo select option{background:var(--panel);color:var(--blanco)}
.campo textarea{resize:vertical;min-height:75px}
.campo input[type="datetime-local"]::-webkit-calendar-picker-indicator{filter:invert(.6)}

/* BOTONES */
.btn{display:inline-flex;align-items:center;gap:7px;padding:10px 22px;border-radius:9px;font-family:'DM Sans',sans-serif;
  font-size:.88rem;font-weight:600;border:none;cursor:pointer;transition:all .2s}
.btn:disabled{opacity:.38;cursor:not-allowed}
.btn-primary{background:linear-gradient(135deg,var(--verde),var(--verde2));color:var(--negro)}
.btn-primary:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 7px 22px rgba(0,229,176,.34)}
.btn-azul{background:linear-gradient(135deg,var(--azul),var(--azul2));color:#fff}
.btn-azul:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 7px 22px rgba(15,76,129,.38)}
.btn-wa{background:linear-gradient(135deg,#25d366,#1ebe5d);color:#fff}
.btn-wa:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 7px 22px rgba(37,211,102,.38)}
.btn-rojo{background:rgba(255,77,109,.15);border:1px solid rgba(255,77,109,.35);color:var(--rojo)}
.btn-rojo:hover:not(:disabled){background:rgba(255,77,109,.25)}
.btn-ghost{background:rgba(255,255,255,.06);border:1px solid var(--borde);color:var(--texto)}
.btn-ghost:hover:not(:disabled){background:rgba(255,255,255,.1);color:var(--blanco)}
.btn-sm{padding:6px 14px;font-size:.78rem}
.fila-btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}

/* TOAST */
#toast-container{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--panel2);border:1px solid var(--borde);border-radius:10px;padding:13px 18px;
  display:flex;align-items:center;gap:10px;min-width:280px;max-width:380px;
  animation:toastIn .3s ease;box-shadow:0 8px 28px rgba(0,0,0,.5);font-size:.87rem;transition:opacity .4s}
.toast.ok{border-left:3px solid var(--verde)}
.toast.err{border-left:3px solid var(--rojo)}
.toast.inf{border-left:3px solid var(--amarillo)}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}

/* CLIENTE BOX */
.cliente-box{background:rgba(0,229,176,.06);border:1px solid rgba(0,229,176,.2);border-radius:10px;padding:14px 16px}
.cliente-box .fila{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:.88rem;
  border-bottom:1px solid rgba(255,255,255,.04)}
.cliente-box .fila:last-child{border:none}
.cliente-box .key{color:var(--texto);opacity:.75}
.cliente-box .val{color:var(--blanco);font-weight:600;text-align:right;max-width:65%}

/* SIM BOX */
.sim-box{background:rgba(26,109,181,.08);border:1px solid rgba(26,109,181,.25);border-radius:10px;padding:14px 16px;margin-top:12px}
.sim-row{display:flex;justify-content:space-between;padding:4px 0;font-size:.86rem;border-bottom:1px solid rgba(255,255,255,.04)}
.sim-row:last-child{border:none}
.sim-row .sk{color:var(--texto);opacity:.7}
.sim-row .sv{color:var(--verde);font-weight:700}

/* TABLA */
.tabla-wrap{overflow-x:auto;border-radius:10px;border:1px solid var(--borde)}
table{width:100%;border-collapse:collapse;font-size:.83rem}
thead th{background:var(--azul);color:#fff;font-weight:700;padding:10px 12px;text-align:left;
  white-space:nowrap;font-family:'Syne',sans-serif;font-size:.78rem;letter-spacing:.04em}
tbody tr{border-bottom:1px solid rgba(30,58,88,.5);transition:background .15s}
tbody tr:hover{background:rgba(255,255,255,.03)}
tbody td{padding:9px 12px;color:var(--texto);vertical-align:middle}
.nombre{color:var(--blanco);font-weight:600}
.id-tag{font-size:.72rem;background:rgba(0,229,176,.1);border:1px solid rgba(0,229,176,.2);
  color:var(--verde);border-radius:6px;padding:2px 7px;display:inline-block}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:4px;font-size:.72rem;font-weight:700;padding:3px 9px;border-radius:20px;white-space:nowrap}
.badge-pendiente{background:rgba(255,193,7,.12);border:1px solid rgba(255,193,7,.3);color:var(--amarillo)}
.badge-confirmada{background:rgba(0,229,176,.12);border:1px solid rgba(0,229,176,.28);color:var(--verde)}
.badge-realizada{background:rgba(26,109,181,.15);border:1px solid rgba(26,109,181,.3);color:#7ab8f5}
.badge-cancelada{background:rgba(255,77,109,.12);border:1px solid rgba(255,77,109,.3);color:var(--rojo)}
.acciones{display:flex;gap:5px;flex-wrap:wrap}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:18px}
@media(max-width:860px){.stats-grid{grid-template-columns:1fr 1fr}}
@media(max-width:480px){.stats-grid{grid-template-columns:1fr}}
.stat-card{background:var(--panel);border:1px solid var(--borde);border-radius:var(--radio);padding:16px 18px;box-shadow:0 4px 20px rgba(0,0,0,.3)}
.stat-card .st-ico{font-size:1.6rem;margin-bottom:6px}
.stat-card .st-num{font-family:'Syne',sans-serif;font-size:1.7rem;font-weight:800;color:var(--blanco)}
.stat-card .st-lbl{font-size:.76rem;color:var(--texto);opacity:.7;margin-top:2px}

/* CALENDARIO */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.cal-header h3{font-family:'Syne',sans-serif;font-size:.95rem;color:var(--blanco)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day-name{text-align:center;font-size:.68rem;font-weight:700;color:var(--texto);opacity:.5;padding:4px 0;text-transform:uppercase}
.cal-day{text-align:center;padding:6px 2px;border-radius:7px;font-size:.8rem;cursor:pointer;
  transition:background .15s;color:var(--texto);position:relative}
.cal-day:hover:not(.vacio){background:rgba(255,255,255,.07)}
.cal-day.hoy{background:var(--azul);color:#fff;font-weight:700}
.cal-day.con-citas::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);
  width:4px;height:4px;border-radius:50%;background:var(--verde)}
.cal-day.seleccionado{background:rgba(0,229,176,.2);border:1px solid rgba(0,229,176,.4);color:var(--verde)}
.cal-day.vacio{cursor:default}

/* MODAL */
.modal-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.7);
  display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .25s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--panel);border:1px solid var(--borde);border-radius:16px;padding:26px;
  width:100%;max-width:600px;max-height:90vh;overflow-y:auto;transform:translateY(20px);transition:transform .25s}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.modal-header h2{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;color:var(--blanco)}
.btn-cerrar{background:none;border:none;color:var(--texto);font-size:1.3rem;cursor:pointer;
  padding:2px 6px;border-radius:6px;transition:color .15s}
.btn-cerrar:hover{color:var(--blanco)}

/* SEARCH BAR */
.search-bar{display:flex;gap:10px;align-items:center;margin-bottom:14px;flex-wrap:wrap}
.search-input{flex:1;min-width:180px;background:rgba(255,255,255,.05);border:1px solid var(--borde);
  border-radius:8px;color:var(--blanco);font-family:'DM Sans',sans-serif;font-size:.88rem;padding:8px 12px;outline:none}
.search-input:focus{border-color:var(--verde)}

/* MISC */
.sep{height:1px;background:var(--borde);margin:16px 0}
.alerta{border-radius:9px;padding:12px 16px;font-size:.86rem;display:flex;align-items:flex-start;gap:10px;margin-bottom:14px}
.alerta-info{background:rgba(26,109,181,.12);border:1px solid rgba(26,109,181,.3);color:#7ab8f5}
.alerta-ok{background:rgba(0,229,176,.1);border:1px solid rgba(0,229,176,.25);color:var(--verde)}
.alerta-warn{background:rgba(255,193,7,.1);border:1px solid rgba(255,193,7,.3);color:var(--amarillo)}
.empty{text-align:center;padding:40px 20px;color:var(--texto);opacity:.5}
.empty .ico{font-size:2.5rem;margin-bottom:10px}
.empty p{font-size:.9rem}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--oscuro)}
::-webkit-scrollbar-thumb{background:var(--borde);border-radius:3px}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="logo">Sim<span>PrÃ©stamo</span></div>
  <div class="topbar-sub">ğŸ“… Agenda de Entrevistas</div>
  <span class="chip chip-wa">ğŸ“± WhatsApp</span>
  <span class="chip chip-ok" id="chip-estado">âš¡ Listo</span>
</div>

<div class="app">

  <!-- URL CONFIG -->
  <div class="url-bar">
    <label>ğŸ”— URL AppScript:</label>
    <input type="url" id="url-script" placeholder="https://script.google.com/macros/s/XXXXXXXXXX/exec">
    <small>Pega la URL de tu Web App publicada (la misma del SimPrÃ©stamo principal)</small>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn activo" onclick="cambiarTab('agendar',this)"><span>ğŸ“…</span> Agendar Cita</button>
    <button class="tab-btn" onclick="cambiarTab('consultar',this)"><span>ğŸ”</span> Mis Citas</button>
    <button class="tab-btn" onclick="cambiarTab('calendario',this)"><span>ğŸ—“ï¸</span> Calendario</button>
    <button class="tab-btn" onclick="cambiarTab('cliente',this)"><span>ğŸ‘¤</span> Ficha Cliente</button>
    <button class="tab-btn" onclick="cambiarTab('notificaciones',this)"><span>ğŸ””</span> Notificaciones</button>
  </div>

  <!-- ============================================================
       TAB 1: AGENDAR CITA
  ============================================================ -->
  <div id="tab-agendar" class="seccion visible">

    <div class="card">
      <div class="card-titulo">ğŸ” Buscar Cliente Interesado</div>
      <div class="g2">
        <div class="campo">
          <label>TelÃ©fono del cliente</label>
          <input type="tel" id="buscar-tel" placeholder="Ej: 4421234567" oninput="limpiarCliente()">
        </div>
        <div class="campo">
          <label>O ID de Cliente</label>
          <input type="text" id="buscar-id" placeholder="Ej: CLI-20260220-XXXXXX">
        </div>
      </div>
      <div class="fila-btns">
        <button class="btn btn-azul" onclick="buscarCliente()">ğŸ” Buscar Cliente</button>
        <button class="btn btn-ghost" onclick="limpiarBusqueda()">âœ• Limpiar</button>
      </div>

      <div id="resultado-cliente" style="display:none;margin-top:16px">
        <div class="sep"></div>
        <div class="card-titulo" style="font-size:.9rem">âœ… Cliente Encontrado</div>
        <div id="cliente-info-box" class="cliente-box"></div>

        <div id="citas-previas" style="display:none;margin-top:14px">
          <div style="font-size:.78rem;font-weight:700;color:var(--verde);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em">
            ğŸ“‹ Citas previas del cliente
          </div>
          <div id="lista-citas-previas"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-titulo">ğŸ“… Datos de la Entrevista</div>
      <div class="g3" style="margin-bottom:14px">
        <div class="campo">
          <label>Fecha y Hora *</label>
          <input type="datetime-local" id="cita-fecha">
        </div>
        <div class="campo">
          <label>Modalidad</label>
          <select id="cita-modalidad">
            <option value="Presencial">ğŸ“ Presencial</option>
            <option value="WhatsApp">ğŸ“± Por WhatsApp</option>
            <option value="Llamada">ğŸ“ Llamada TelefÃ³nica</option>
            <option value="Videollamada">ğŸ’» Videollamada</option>
          </select>
        </div>
        <div class="campo">
          <label>DuraciÃ³n estimada</label>
          <select id="cita-duracion">
            <option value="15">15 minutos</option>
            <option value="30" selected>30 minutos</option>
            <option value="45">45 minutos</option>
            <option value="60">1 hora</option>
          </select>
        </div>
      </div>
      <div class="g2" style="margin-bottom:14px">
        <div class="campo">
          <label>Lugar / DirecciÃ³n</label>
          <input type="text" id="cita-lugar" placeholder="Ej: Oficina QuerÃ©taro, Blvd. Bernardo Quintana 100">
        </div>
        <div class="campo">
          <label>Asesor Responsable</label>
          <input type="text" id="cita-asesor" placeholder="Nombre del asesor">
        </div>
      </div>
      <div class="campo" style="margin-bottom:14px">
        <label>PropÃ³sito / Notas de la entrevista</label>
        <textarea id="cita-notas" placeholder="Ej: Revisar documentaciÃ³n, confirmar datos de simulaciÃ³n, evaluar capacidad de pago..."></textarea>
      </div>
      <div class="campo" style="margin-bottom:14px">
        <label>ID SimulaciÃ³n vinculada (opcional)</label>
        <input type="text" id="cita-sim-id" placeholder="Se puede llenar manualmente. Ej: SIM-20260220-...">
      </div>

      <div class="alerta alerta-info">
        <span>â„¹ï¸</span>
        <div>Al agendar se genera automÃ¡ticamente el enlace de <strong>WhatsApp</strong> para notificar al cliente y se puede enviar recordatorio por <strong>correo</strong>.</div>
      </div>

      <div class="fila-btns">
        <button class="btn btn-primary" onclick="agendarCita()">ğŸ“… Agendar Entrevista</button>
        <button class="btn btn-wa" id="btn-wa-confirm" disabled onclick="notificarWhatsApp()">ğŸ“± Notificar por WA</button>
        <button class="btn btn-ghost" onclick="limpiarFormCita()">ğŸ”„ Limpiar</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB 2: MIS CITAS
  ============================================================ -->
  <div id="tab-consultar" class="seccion">

    <div class="stats-grid">
      <div class="stat-card"><div class="st-ico">ğŸ“…</div><div class="st-num" id="stat-total">0</div><div class="st-lbl">Total Citas</div></div>
      <div class="stat-card"><div class="st-ico">â³</div><div class="st-num" id="stat-pendientes">0</div><div class="st-lbl">Pendientes</div></div>
      <div class="stat-card"><div class="st-ico">ğŸ¯</div><div class="st-num" id="stat-realizadas">0</div><div class="st-lbl">Realizadas</div></div>
      <div class="stat-card"><div class="st-ico">âŒ</div><div class="st-num" id="stat-canceladas">0</div><div class="st-lbl">Canceladas</div></div>
    </div>

    <div class="card">
      <div class="card-titulo">ğŸ“‹ Lista de Entrevistas Agendadas</div>
      <div class="search-bar">
        <input class="search-input" id="filtro-citas" placeholder="ğŸ” Buscar por nombre, telÃ©fono, fecha, asesor..." oninput="filtrarCitas()">
        <select class="search-input" style="max-width:170px" id="filtro-estado" onchange="filtrarCitas()">
          <option value="">Todos los estados</option>
          <option value="Pendiente">â³ Pendiente</option>
          <option value="Confirmada">âœ… Confirmada</option>
          <option value="Realizada">ğŸ¯ Realizada</option>
          <option value="Cancelada">âŒ Cancelada</option>
        </select>
        <button class="btn btn-azul btn-sm" onclick="cargarCitas()">ğŸ”„ Actualizar</button>
        <button class="btn btn-primary btn-sm" onclick="exportarCSV()">â¬‡ï¸ CSV</button>
      </div>
      <div class="tabla-wrap">
        <table>
          <thead>
            <tr>
              <th>ID Cita</th><th>Cliente</th><th>TelÃ©fono</th>
              <th>Fecha / Hora</th><th>Modalidad</th><th>Estado</th>
              <th>Asesor</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="tabla-citas-body">
            <tr><td colspan="8"><div class="empty"><div class="ico">ğŸ“­</div><p>Presiona "Actualizar" para ver las citas</p></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB 3: CALENDARIO
  ============================================================ -->
  <div id="tab-calendario" class="seccion">
    <div class="g2">
      <div class="card">
        <div class="card-titulo">ğŸ—“ï¸ Calendario Mensual</div>
        <div class="cal-header">
          <button class="btn btn-ghost btn-sm" onclick="navMes(-1)">â—€</button>
          <h3 id="cal-mes-titulo"></h3>
          <button class="btn btn-ghost btn-sm" onclick="navMes(1)">â–¶</button>
        </div>
        <div class="cal-grid" id="cal-grid"></div>
        <div style="margin-top:12px;display:flex;gap:14px;font-size:.74rem;color:var(--texto);opacity:.7">
          <span>â— Punto verde = citas agendadas</span>
          <span style="color:var(--azul2)">â–  Azul = hoy</span>
        </div>
      </div>
      <div class="card">
        <div class="card-titulo">ğŸ“… Citas del dÃ­a seleccionado</div>
        <div id="citas-dia">
          <div class="empty"><div class="ico">ğŸ‘†</div><p>Selecciona un dÃ­a en el calendario</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB 4: FICHA CLIENTE
  ============================================================ -->
  <div id="tab-cliente" class="seccion">
    <div class="card">
      <div class="card-titulo">ğŸ” Buscar Cliente</div>
      <div class="g2">
        <div class="campo">
          <label>TelÃ©fono o ID Cliente</label>
          <input type="text" id="ficha-buscar" placeholder="Ej: 4421234567 o CLI-20260220-XXXXX">
        </div>
        <div style="display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap">
          <button class="btn btn-azul" onclick="buscarFichaCliente()">ğŸ” Ver Ficha</button>
          <button class="btn btn-ghost" onclick="cargarTodosClientes()">ğŸ‘¥ Ver Todos</button>
        </div>
      </div>
    </div>

    <div id="ficha-resultado" style="display:none">
      <div class="g2">
        <div class="card">
          <div class="card-titulo">ğŸ‘¤ Datos del Cliente</div>
          <div id="ficha-datos"></div>
          <div class="fila-btns" style="margin-top:14px">
            <button class="btn btn-wa btn-sm" id="btn-wa-ficha">ğŸ“± WhatsApp</button>
            <button class="btn btn-azul btn-sm" onclick="agendarDesdeficha()">ğŸ“… Agendar Cita</button>
          </div>
        </div>
        <div class="card">
          <div class="card-titulo">ğŸ“Š Resumen de Simulaciones</div>
          <div id="ficha-simulaciones"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-titulo">ğŸ“… Historial de Citas</div>
        <div id="ficha-citas"></div>
      </div>
    </div>

    <div id="todos-clientes" style="display:none">
      <div class="card">
        <div class="card-titulo">ğŸ‘¥ Todos los Clientes</div>
        <div class="search-bar">
          <input class="search-input" id="filtro-clientes" placeholder="ğŸ” Buscar por nombre, telÃ©fono, correo..." oninput="filtrarClientes()">
        </div>
        <div class="tabla-wrap">
          <table>
            <thead>
              <tr><th>ID Cliente</th><th>Nombre</th><th>TelÃ©fono</th><th>Correo</th><th>Simulaciones</th><th>Estado</th><th>Acciones</th></tr>
            </thead>
            <tbody id="tabla-clientes-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       TAB 5: NOTIFICACIONES
  ============================================================ -->
  <div id="tab-notificaciones" class="seccion">
    <div class="card">
      <div class="card-titulo">ğŸ“¬ Enviar NotificaciÃ³n al Cliente</div>
      <div class="alerta alerta-info">
        <span>â„¹ï¸</span>
        <span>Genera mensajes personalizados con los datos de la simulaciÃ³n y cita. EnvÃ­a por <strong>WhatsApp</strong> o <strong>Email</strong>.</span>
      </div>
      <div class="g2" style="margin-bottom:14px">
        <div class="campo">
          <label>Nombre del cliente</label>
          <input type="text" id="notif-nombre" placeholder="MarÃ­a GarcÃ­a LÃ³pez">
        </div>
        <div class="campo">
          <label>TelÃ©fono WhatsApp</label>
          <input type="tel" id="notif-tel" placeholder="4421234567 (sin +52)">
        </div>
      </div>
      <div class="g2" style="margin-bottom:14px">
        <div class="campo">
          <label>Correo electrÃ³nico</label>
          <input type="email" id="notif-email" placeholder="cliente@correo.com">
        </div>
        <div class="campo">
          <label>Tipo de mensaje</label>
          <select id="notif-tipo" onchange="actualizarPlantilla()">
            <option value="confirmacion">âœ… ConfirmaciÃ³n de cita</option>
            <option value="recordatorio">â° Recordatorio 24h antes</option>
            <option value="resultado">ğŸ’° Resultado de simulaciÃ³n</option>
            <option value="reprogramar">ğŸ“… Cita reprogramada</option>
            <option value="personalizado">âœï¸ Mensaje personalizado</option>
          </select>
        </div>
      </div>
      <div id="notif-sim-datos" style="margin-bottom:14px">
        <div class="sep"></div>
        <div style="font-size:.78rem;font-weight:700;color:var(--verde);margin-bottom:10px;text-transform:uppercase;letter-spacing:.06em">
          ğŸ’° Datos de simulaciÃ³n para incluir en el mensaje
        </div>
        <div class="g4">
          <div class="campo"><label>Capital</label><input type="number" id="notif-capital" placeholder="5000"></div>
          <div class="campo"><label>DÃ­as</label><input type="number" id="notif-dias" placeholder="27"></div>
          <div class="campo"><label>Pago diario $</label><input type="number" id="notif-pago" placeholder="225"></div>
          <div class="campo"><label>Total a pagar $</label><input type="number" id="notif-total" placeholder="6075"></div>
        </div>
        <div class="g2" style="margin-top:10px">
          <div class="campo">
            <label>Fecha de cita</label>
            <input type="datetime-local" id="notif-fecha-cita">
          </div>
          <div class="campo">
            <label>Lugar</label>
            <input type="text" id="notif-lugar" placeholder="Oficina QuerÃ©taro">
          </div>
        </div>
      </div>
      <div class="campo" style="margin-bottom:14px">
        <label>Vista previa del mensaje (editable)</label>
        <textarea id="notif-preview" rows="11" style="font-size:.82rem;font-family:monospace;line-height:1.5"></textarea>
      </div>
      <div class="fila-btns">
        <button class="btn btn-wa" onclick="enviarNotifWA()">ğŸ“± Abrir WhatsApp</button>
        <button class="btn btn-primary" onclick="enviarNotifEmail()">ğŸ“§ Enviar Email</button>
        <button class="btn btn-ghost" onclick="actualizarPlantilla()">ğŸ”„ Regenerar</button>
      </div>
    </div>

    <div class="card">
      <div class="card-titulo">ğŸ“‹ Historial de Notificaciones (sesiÃ³n)</div>
      <div id="log-notificaciones">
        <div class="empty"><div class="ico">ğŸ“­</div><p>Sin notificaciones enviadas aÃºn</p></div>
      </div>
    </div>
  </div>

</div><!-- /app -->

<!-- MODAL -->
<div class="modal-overlay" id="modal-editar">
  <div class="modal">
    <div class="modal-header">
      <h2>ğŸ“‹ Detalle de Cita</h2>
      <button class="btn-cerrar" onclick="cerrarModal()">âœ•</button>
    </div>
    <div id="modal-contenido"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast-container"></div>

<script>
// =====================================================
// CONFIG
// =====================================================
const CITAS_KEY = 'simprestamo_citas_v2';
const LOG_KEY   = 'simprestamo_log_v1';
const URL_KEY   = 'simprestamo_url';

// ESTADO
let clienteActual   = null;
let citasLocales    = lsGet(CITAS_KEY, []);
let logNotif        = lsGet(LOG_KEY, []);
let todosClientes   = [];
let diaSeleccionado = null;
let calMes          = new Date();

// =====================================================
// UTILS
// =====================================================
function lsGet(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } }
function lsSet(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} }

function getUrl(){ return document.getElementById('url-script').value.trim() }

function fmt(n){
  if(n===null||n===undefined||n==='') return 'â€”';
  return '$'+Number(n).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function fmtFecha(s){
  if(!s) return 'â€”';
  const d=new Date(s);
  if(isNaN(d)) return s;
  return d.toLocaleString('es-MX',{dateStyle:'medium',timeStyle:'short'});
}
function fechaAhora(){
  const n=new Date(); n.setMinutes(n.getMinutes()-n.getTimezoneOffset());
  return n.toISOString().slice(0,16);
}
function genId(){
  return 'CIT-'+Date.now().toString(36).toUpperCase()+'-'+Math.random().toString(36).slice(2,6).toUpperCase();
}

// TOAST
function toast(msg, tipo='ok', dur=4000){
  const c=document.getElementById('toast-container');
  const t=document.createElement('div');
  const ico=tipo==='ok'?'âœ…':tipo==='err'?'âŒ':'â„¹ï¸';
  t.className=`toast ${tipo}`;
  t.innerHTML=`<span>${ico}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(()=>t.style.opacity='0',dur-500);
  setTimeout(()=>t.remove(),dur);
}

// BADGE
function badgeHtml(estado){
  const m={
    'Pendiente':  ['badge-pendiente','â³'],
    'Confirmada': ['badge-confirmada','âœ…'],
    'Realizada':  ['badge-realizada','ğŸ¯'],
    'Cancelada':  ['badge-cancelada','âŒ'],
    'Activo':     ['badge-confirmada','âœ…'],
    'Inactivo':   ['badge-cancelada','âŒ'],
  };
  const [cls,ico]=m[estado]||['badge-pendiente','â³'];
  return `<span class="badge ${cls}">${ico} ${estado}</span>`;
}

// =====================================================
// TABS
// =====================================================
function cambiarTab(id, btn){
  document.querySelectorAll('.seccion').forEach(s=>s.classList.remove('visible'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('activo'));
  document.getElementById('tab-'+id).classList.add('visible');
  btn.classList.add('activo');
  if(id==='consultar') cargarCitas();
  if(id==='calendario') renderCalendario();
  if(id==='notificaciones') actualizarPlantilla();
}

// =====================================================
// FETCH GAS
// =====================================================
async function fetchGAS(tipo){
  const url=getUrl();
  if(!url){ toast('Configura la URL del AppScript primero','err'); return null; }
  try{
    const r=await fetch(`${url}?tipo=${tipo}`,{redirect:'follow'});
    return await r.json();
  }catch(e){ return null; }
}

// =====================================================
// TAB 1 â€” AGENDAR
// =====================================================
async function buscarCliente(){
  const tel=document.getElementById('buscar-tel').value.trim();
  const id=document.getElementById('buscar-id').value.trim();
  if(!tel&&!id){ toast('Ingresa telÃ©fono o ID de cliente','inf'); return; }

  const btn=event.target; btn.disabled=true; btn.textContent='Buscando...';
  toast('Conectando con Google Sheets...','inf',2500);

  const datos=await fetchGAS('clientes');
  btn.disabled=false; btn.innerHTML='ğŸ” Buscar Cliente';

  if(!datos?.success){ toast('No se pudo conectar. Verifica la URL del AppScript.','err'); return; }

  const clientes=datos.data?.clientes||[];
  let c=null;

  if(tel) c=clientes.find(cl=>String(cl.telefono).replace(/\D/g,'')=== tel.replace(/\D/g,''));
  if(!c&&id) c=clientes.find(cl=>cl.idCliente===id);

  if(!c){ toast('Cliente no encontrado. Verifica el nÃºmero.','err'); return; }

  clienteActual=c;
  mostrarCliente(c);
  toast('âœ… Cliente encontrado','ok');
}

function mostrarCliente(c){
  const estado=String(c.estado||'Activo').replace(/[âœ…âŒ]\s*/,'');
  document.getElementById('cliente-info-box').innerHTML=`
    <div class="fila"><span class="key">ğŸ†” ID Cliente</span><span class="val"><span class="id-tag">${c.idCliente||'â€”'}</span></span></div>
    <div class="fila"><span class="key">ğŸ‘¤ Nombre</span><span class="val">${c.nombreCliente||'Sin datos'}</span></div>
    <div class="fila"><span class="key">ğŸ“ TelÃ©fono</span><span class="val">${c.telefono||'â€”'}</span></div>
    <div class="fila"><span class="key">ğŸ“§ Correo</span><span class="val">${c.correo||'No registrado'}</span></div>
    <div class="fila"><span class="key">ğŸ“ UbicaciÃ³n</span><span class="val">${c.ubicacion||'No registrada'}</span></div>
    <div class="fila"><span class="key">ğŸ“Š Simulaciones</span><span class="val">${c.cantidadSimulaciones||0}</span></div>
    <div class="fila"><span class="key">ğŸ“… Registrado</span><span class="val">${c.fechaRegistro||'â€”'}</span></div>
    <div class="fila"><span class="key">ğŸ”” Estado</span><span class="val">${badgeHtml(estado)}</span></div>
  `;

  document.getElementById('resultado-cliente').style.display='block';
  document.getElementById('btn-wa-confirm').disabled=false;
  document.getElementById('cita-fecha').value=fechaAhora();

  // Citas previas
  const previas=citasLocales.filter(ct=>ct.idCliente===c.idCliente);
  const divPrev=document.getElementById('citas-previas');
  const listPrev=document.getElementById('lista-citas-previas');
  if(previas.length){
    divPrev.style.display='block';
    listPrev.innerHTML=previas.map(ct=>`
      <div class="sim-box" style="margin-bottom:8px">
        <div class="sim-row"><span class="sk">ğŸ“… Fecha</span><span class="sv">${fmtFecha(ct.fecha)}</span></div>
        <div class="sim-row"><span class="sk">Estado</span><span class="sv">${badgeHtml(ct.estado)}</span></div>
        <div class="sim-row"><span class="sk">Modalidad</span><span class="sv">${ct.modalidad||'â€”'}</span></div>
      </div>
    `).join('');
  }

  // Pre-fill notif
  document.getElementById('notif-nombre').value=c.nombreCliente||'';
  document.getElementById('notif-tel').value=c.telefono||'';
  document.getElementById('notif-email').value=c.correo||'';
}

function limpiarCliente(){
  clienteActual=null;
  document.getElementById('resultado-cliente').style.display='none';
  document.getElementById('btn-wa-confirm').disabled=true;
  document.getElementById('citas-previas').style.display='none';
}
function limpiarBusqueda(){
  limpiarCliente();
  document.getElementById('buscar-tel').value='';
  document.getElementById('buscar-id').value='';
}
function limpiarFormCita(){
  ['cita-fecha','cita-lugar','cita-asesor','cita-notas','cita-sim-id'].forEach(id=>document.getElementById(id).value='');
}

function agendarCita(){
  const fecha=document.getElementById('cita-fecha').value;
  if(!fecha){ toast('Selecciona fecha y hora','err'); return; }
  if(!clienteActual){ toast('Busca un cliente primero','err'); return; }

  const cita={
    id:        genId(),
    idCliente: clienteActual.idCliente,
    nombre:    clienteActual.nombreCliente,
    telefono:  clienteActual.telefono,
    correo:    clienteActual.correo,
    ubicacion: clienteActual.ubicacion,
    fecha,
    modalidad: document.getElementById('cita-modalidad').value,
    duracion:  document.getElementById('cita-duracion').value,
    lugar:     document.getElementById('cita-lugar').value,
    asesor:    document.getElementById('cita-asesor').value,
    notas:     document.getElementById('cita-notas').value,
    simId:     document.getElementById('cita-sim-id').value,
    estado:    'Pendiente',
    creada:    new Date().toISOString()
  };

  citasLocales.unshift(cita);
  lsSet(CITAS_KEY, citasLocales);

  toast('âœ… Cita agendada correctamente','ok');
  actualizarStats();

  // Pre-llenar notificaciones
  document.getElementById('notif-fecha-cita').value=fecha;
  document.getElementById('notif-lugar').value=cita.lugar||'';

  registrarLog('Sistema', `Cita agendada para ${cita.nombre} â€” ${fmtFecha(fecha)}`, cita.id);
}

function notificarWhatsApp(){
  if(!clienteActual){ toast('Busca un cliente primero','err'); return; }
  const fecha=document.getElementById('cita-fecha').value;
  const lugar=document.getElementById('cita-lugar').value;
  const mod=document.getElementById('cita-modalidad').value;

  const msg=[
    `âœ… *CONFIRMACIÃ“N DE ENTREVISTA*`,``,
    `Hola *${clienteActual.nombreCliente}*, le confirmamos su cita con SimPrÃ©stamo.`,``,
    fecha?`ğŸ“… *Fecha:* ${fmtFecha(fecha)}`:'',
    lugar?`ğŸ“ *Lugar:* ${lugar}`:'',
    `ğŸ“‹ *Modalidad:* ${mod}`,``,
    `Para la entrevista recuerde llevar:`,
    `â€¢ IdentificaciÃ³n oficial (INE)`,
    `â€¢ Comprobante de domicilio reciente`,
    `â€¢ Comprobante de ingresos`,``,
    `Â¿Alguna duda? Responda este mensaje.`,``,
    `_SimPrÃ©stamo â€” ${new Date().toLocaleDateString('es-MX')}_`
  ].filter(Boolean).join('\n');

  const tel=clienteActual.telefono?.replace(/\D/g,'');
  const n=tel?.length===10?'52'+tel:tel;
  window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`,'_blank');
  registrarLog('WhatsApp',`ConfirmaciÃ³n enviada a ${clienteActual.nombreCliente}`, 'agendar');
  toast('ğŸ“± WhatsApp abierto','ok');
}

// =====================================================
// TAB 2 â€” MIS CITAS
// =====================================================
function cargarCitas(){
  actualizarStats();
  renderTablaCitas(citasLocales);
}

function actualizarStats(){
  document.getElementById('stat-total').textContent=citasLocales.length;
  document.getElementById('stat-pendientes').textContent=citasLocales.filter(c=>c.estado==='Pendiente').length;
  document.getElementById('stat-realizadas').textContent=citasLocales.filter(c=>c.estado==='Realizada').length;
  document.getElementById('stat-canceladas').textContent=citasLocales.filter(c=>c.estado==='Cancelada').length;
}

function renderTablaCitas(lista){
  const tbody=document.getElementById('tabla-citas-body');
  if(!lista.length){
    tbody.innerHTML=`<tr><td colspan="8"><div class="empty"><div class="ico">ğŸ“­</div><p>Sin citas. Usa la pestaÃ±a "Agendar Cita" para crear la primera.</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML=lista.map(c=>`
    <tr>
      <td><span class="id-tag">${c.id}</span></td>
      <td><span class="nombre">${c.nombre||'â€”'}</span></td>
      <td>${c.telefono||'â€”'}</td>
      <td>${fmtFecha(c.fecha)}</td>
      <td>${c.modalidad||'â€”'}</td>
      <td>${badgeHtml(c.estado)}</td>
      <td>${c.asesor||'â€”'}</td>
      <td>
        <div class="acciones">
          <button class="btn btn-ghost btn-sm" onclick="verCita('${c.id}')">ğŸ‘ï¸</button>
          <button class="btn btn-primary btn-sm" onclick="cambiarEstado('${c.id}','Realizada')">ğŸ¯</button>
          <button class="btn btn-wa btn-sm" onclick="waRapido('${c.id}')">ğŸ“±</button>
          <button class="btn btn-rojo btn-sm" onclick="cambiarEstado('${c.id}','Cancelada')">âŒ</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function filtrarCitas(){
  const q=document.getElementById('filtro-citas').value.toLowerCase();
  const est=document.getElementById('filtro-estado').value;
  renderTablaCitas(citasLocales.filter(c=>{
    const txt=`${c.nombre} ${c.telefono} ${c.fecha} ${c.asesor} ${c.lugar}`.toLowerCase();
    return (!q||txt.includes(q))&&(!est||c.estado===est);
  }));
}

function cambiarEstado(id, nuevoEstado){
  const idx=citasLocales.findIndex(c=>c.id===id);
  if(idx<0) return;
  citasLocales[idx].estado=nuevoEstado;
  lsSet(CITAS_KEY,citasLocales);
  cargarCitas();
  renderCalendario();
  toast(`Estado â†’ ${nuevoEstado}`,'ok');
}

function verCita(id){
  const c=citasLocales.find(ct=>ct.id===id);
  if(!c) return;
  document.getElementById('modal-contenido').innerHTML=`
    <div class="cliente-box" style="margin-bottom:14px">
      <div class="fila"><span class="key">ğŸ†” ID Cita</span><span class="val"><span class="id-tag">${c.id}</span></span></div>
      <div class="fila"><span class="key">ğŸ‘¤ Cliente</span><span class="val">${c.nombre}</span></div>
      <div class="fila"><span class="key">ğŸ“ TelÃ©fono</span><span class="val">${c.telefono||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ“§ Correo</span><span class="val">${c.correo||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ“… Fecha</span><span class="val">${fmtFecha(c.fecha)}</span></div>
      <div class="fila"><span class="key">â± DuraciÃ³n</span><span class="val">${c.duracion||30} min</span></div>
      <div class="fila"><span class="key">ğŸ“‹ Modalidad</span><span class="val">${c.modalidad||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ“ Lugar</span><span class="val">${c.lugar||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ§‘ Asesor</span><span class="val">${c.asesor||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ”” Estado</span><span class="val">${badgeHtml(c.estado)}</span></div>
      ${c.simId?`<div class="fila"><span class="key">ğŸ†” SimulaciÃ³n</span><span class="val"><span class="id-tag">${c.simId}</span></span></div>`:''}
      ${c.notas?`<div class="fila"><span class="key">ğŸ“ Notas</span><span class="val">${c.notas}</span></div>`:''}
    </div>
    <div class="sep"></div>
    <div style="font-size:.78rem;font-weight:700;color:var(--verde);margin-bottom:10px;text-transform:uppercase">Cambiar estado</div>
    <div class="fila-btns" style="flex-wrap:wrap">
      <button class="btn btn-ghost btn-sm" onclick="cambiarEstado('${c.id}','Pendiente');cerrarModal()">â³ Pendiente</button>
      <button class="btn btn-primary btn-sm" onclick="cambiarEstado('${c.id}','Confirmada');cerrarModal()">âœ… Confirmada</button>
      <button class="btn btn-azul btn-sm" onclick="cambiarEstado('${c.id}','Realizada');cerrarModal()">ğŸ¯ Realizada</button>
      <button class="btn btn-rojo btn-sm" onclick="cambiarEstado('${c.id}','Cancelada');cerrarModal()">âŒ Cancelada</button>
    </div>
    <div class="sep"></div>
    <div class="fila-btns">
      <button class="btn btn-wa btn-sm" onclick="waRapido('${c.id}')">ğŸ“± WhatsApp cliente</button>
      <button class="btn btn-ghost btn-sm" onclick="reprogramar('${c.id}')">ğŸ“… Reprogramar</button>
    </div>
  `;
  document.getElementById('modal-editar').classList.add('open');
}

function reprogramar(id){
  const c=citasLocales.find(ct=>ct.id===id);
  if(!c) return;
  const nueva=prompt('Nueva fecha y hora (YYYY-MM-DDTHH:MM):\nEjemplo: 2026-03-15T10:00');
  if(!nueva) return;
  const idx=citasLocales.findIndex(ct=>ct.id===id);
  citasLocales[idx].fecha=nueva;
  citasLocales[idx].estado='Pendiente';
  lsSet(CITAS_KEY,citasLocales);
  cargarCitas(); renderCalendario(); cerrarModal();
  toast('âœ… Cita reprogramada','ok');

  // Notificar WA
  const msg=[
    `ğŸ“… *CITA REPROGRAMADA*`,``,
    `Hola *${c.nombre}*, su entrevista fue reprogramada.`,``,
    `ğŸ“… *Nueva fecha:* ${fmtFecha(nueva)}`,
    c.lugar?`ğŸ“ *Lugar:* ${c.lugar}`:'',``,
    `Por favor confirme su asistencia respondiendo este mensaje.`,
    `_SimPrÃ©stamo_`
  ].filter(Boolean).join('\n');
  const tel=c.telefono?.replace(/\D/g,'');
  const n=tel?.length===10?'52'+tel:tel;
  if(confirm('Â¿Notificar al cliente por WhatsApp?'))
    window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`,'_blank');
}

function waRapido(id){
  const c=citasLocales.find(ct=>ct.id===id);
  if(!c) return;
  const msg=[
    `âœ… *RECORDATORIO DE ENTREVISTA â€” SimPrÃ©stamo*`,``,
    `Hola *${c.nombre}*, le recordamos su cita.`,``,
    `ğŸ“… *Fecha:* ${fmtFecha(c.fecha)}`,
    c.lugar?`ğŸ“ *Lugar:* ${c.lugar}`:'',
    `ğŸ“‹ *Modalidad:* ${c.modalidad}`,``,
    `Â¿Alguna duda? ContÃ¡ctenos.`,
    `_SimPrÃ©stamo â€” ${new Date().toLocaleDateString('es-MX')}_`
  ].filter(Boolean).join('\n');
  const tel=c.telefono?.replace(/\D/g,'');
  const n=tel?.length===10?'52'+tel:tel;
  window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`,'_blank');
  registrarLog('WhatsApp',`Recordatorio enviado a ${c.nombre}`,c.id);
}

function cerrarModal(){ document.getElementById('modal-editar').classList.remove('open') }

function exportarCSV(){
  const cab=['ID','Cliente','TelÃ©fono','Correo','Fecha','Modalidad','Lugar','Asesor','Estado','Notas','SimID'];
  const rows=citasLocales.map(c=>[
    c.id,c.nombre,c.telefono,c.correo,fmtFecha(c.fecha),
    c.modalidad,c.lugar,c.asesor,c.estado,c.notas,c.simId
  ].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv=[cab.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download=`Citas_SimPrestamo_${new Date().toLocaleDateString('es-MX').replace(/\//g,'-')}.csv`;
  a.click();
  toast('âœ… CSV exportado','ok');
}

// =====================================================
// TAB 3 â€” CALENDARIO
// =====================================================
function renderCalendario(){
  const y=calMes.getFullYear(), m=calMes.getMonth();
  const mNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  document.getElementById('cal-mes-titulo').textContent=`${mNombres[m]} ${y}`;

  const diasMes=new Date(y,m+1,0).getDate();
  const offset=(new Date(y,m,1).getDay()+6)%7; // lunes=0

  const diasConCitas=new Set(
    citasLocales
      .filter(c=>{ const d=new Date(c.fecha); return d.getFullYear()===y&&d.getMonth()===m&&c.estado!=='Cancelada'; })
      .map(c=>new Date(c.fecha).getDate())
  );

  const hoy=new Date();
  const dias=['Lu','Ma','Mi','Ju','Vi','SÃ¡','Do'];
  let html=dias.map(d=>`<div class="cal-day-name">${d}</div>`).join('');
  for(let i=0;i<offset;i++) html+=`<div class="cal-day vacio"></div>`;
  for(let d=1;d<=diasMes;d++){
    const esHoy=hoy.getFullYear()===y&&hoy.getMonth()===m&&hoy.getDate()===d;
    const esSel=diaSeleccionado&&diaSeleccionado.getFullYear()===y&&diaSeleccionado.getMonth()===m&&diaSeleccionado.getDate()===d;
    const conCitas=diasConCitas.has(d);
    html+=`<div class="cal-day${esHoy?' hoy':''}${esSel?' seleccionado':''}${conCitas?' con-citas':''}" onclick="seleccionarDia(${y},${m},${d})">${d}</div>`;
  }
  document.getElementById('cal-grid').innerHTML=html;
}

function navMes(dir){
  calMes.setMonth(calMes.getMonth()+dir);
  renderCalendario();
}

function seleccionarDia(y,m,d){
  diaSeleccionado=new Date(y,m,d);
  renderCalendario();
  const citas=citasLocales.filter(c=>{
    const cd=new Date(c.fecha);
    return cd.getFullYear()===y&&cd.getMonth()===m&&cd.getDate()===d;
  });
  const div=document.getElementById('citas-dia');
  if(!citas.length){
    div.innerHTML=`<div class="empty"><div class="ico">ğŸ“­</div><p>Sin citas para el ${d}/${m+1}/${y}</p><button class="btn btn-azul btn-sm" style="margin-top:12px" onclick="irAAgendarFecha(${y},${m},${d})">+ Agendar para este dÃ­a</button></div>`;
    return;
  }
  div.innerHTML=citas.map(c=>`
    <div class="sim-box" style="margin-bottom:10px">
      <div class="sim-row"><span class="sk">ğŸ‘¤</span><span class="sv">${c.nombre}</span></div>
      <div class="sim-row"><span class="sk">â°</span><span class="sv">${new Date(c.fecha).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'})}</span></div>
      <div class="sim-row"><span class="sk">ğŸ“‹</span><span class="sv">${c.modalidad}</span></div>
      <div class="sim-row"><span class="sk">ğŸ””</span><span class="sv">${badgeHtml(c.estado)}</span></div>
      ${c.asesor?`<div class="sim-row"><span class="sk">ğŸ§‘</span><span class="sv">${c.asesor}</span></div>`:''}
      <div class="fila-btns" style="margin-top:8px">
        <button class="btn btn-ghost btn-sm" onclick="verCita('${c.id}')">ğŸ‘ï¸ Ver</button>
        <button class="btn btn-wa btn-sm" onclick="waRapido('${c.id}')">ğŸ“± WA</button>
      </div>
    </div>
  `).join('');
}

function irAAgendarFecha(y,m,d){
  document.querySelector('[onclick*="agendar"]').click();
  const dt=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}T09:00`;
  document.getElementById('cita-fecha').value=dt;
}

// =====================================================
// TAB 4 â€” FICHA CLIENTE
// =====================================================
async function buscarFichaCliente(){
  const q=document.getElementById('ficha-buscar').value.trim();
  if(!q){ toast('Ingresa telÃ©fono o ID','inf'); return; }

  const datos=await fetchGAS('clientes');
  if(!datos?.success){ toast('Error de conexiÃ³n','err'); return; }

  const c=datos.data?.clientes?.find(cl=>
    String(cl.telefono).replace(/\D/g,'')=== q.replace(/\D/g,'') || cl.idCliente===q
  );
  if(!c){ toast('Cliente no encontrado','err'); return; }
  mostrarFichaCliente(c);
}

async function cargarTodosClientes(){
  toast('Cargando clientes...','inf',2500);
  const datos=await fetchGAS('clientes');
  if(!datos?.success){ toast('Error de conexiÃ³n','err'); return; }
  todosClientes=datos.data?.clientes||[];
  document.getElementById('todos-clientes').style.display='block';
  document.getElementById('ficha-resultado').style.display='none';
  renderTablaClientes(todosClientes);
  toast(`${todosClientes.length} clientes cargados`,'ok');
}

function filtrarClientes(){
  const q=document.getElementById('filtro-clientes').value.toLowerCase();
  renderTablaClientes(todosClientes.filter(c=>
    `${c.nombreCliente} ${c.telefono} ${c.correo} ${c.idCliente}`.toLowerCase().includes(q)
  ));
}

function renderTablaClientes(lista){
  const tbody=document.getElementById('tabla-clientes-body');
  if(!lista.length){
    tbody.innerHTML=`<tr><td colspan="7"><div class="empty"><div class="ico">ğŸ“­</div><p>Sin resultados</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML=lista.map(c=>`
    <tr>
      <td><span class="id-tag">${c.idCliente}</span></td>
      <td><span class="nombre">${c.nombreCliente||'â€”'}</span></td>
      <td>${c.telefono||'â€”'}</td>
      <td>${c.correo||'â€”'}</td>
      <td>${c.cantidadSimulaciones||0}</td>
      <td>${badgeHtml(String(c.estado||'Activo').replace(/[âœ…âŒ]\s*/,''))}</td>
      <td>
        <div class="acciones">
          <button class="btn btn-ghost btn-sm" onclick='mostrarFichaClienteStr(${JSON.stringify(JSON.stringify(c))})'>ğŸ‘ï¸</button>
          <button class="btn btn-wa btn-sm" onclick="waCliente('${c.telefono}')">ğŸ“±</button>
          <button class="btn btn-azul btn-sm" onclick='agendarDesdeLista(${JSON.stringify(JSON.stringify(c))})'>ğŸ“…</button>
        </div>
      </td>
    </tr>
  `).join('');
}

function mostrarFichaClienteStr(str){ mostrarFichaCliente(JSON.parse(str)); }
function agendarDesdeLista(str){ mostrarFichaCliente(JSON.parse(str)); agendarDesdeficha(); }

function mostrarFichaCliente(c){
  clienteActual=c;
  document.getElementById('todos-clientes').style.display='none';
  document.getElementById('ficha-resultado').style.display='block';

  const estado=String(c.estado||'Activo').replace(/[âœ…âŒ]\s*/,'');
  document.getElementById('ficha-datos').innerHTML=`
    <div class="cliente-box">
      <div class="fila"><span class="key">ğŸ†” ID</span><span class="val"><span class="id-tag">${c.idCliente}</span></span></div>
      <div class="fila"><span class="key">ğŸ‘¤ Nombre</span><span class="val">${c.nombreCliente||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ“ TelÃ©fono</span><span class="val">${c.telefono||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ“§ Correo</span><span class="val">${c.correo||'No registrado'}</span></div>
      <div class="fila"><span class="key">ğŸ“ UbicaciÃ³n</span><span class="val">${c.ubicacion||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ“Š Simulaciones</span><span class="val">${c.cantidadSimulaciones||0}</span></div>
      <div class="fila"><span class="key">ğŸ“… Registrado</span><span class="val">${c.fechaRegistro||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ”„ Ãšltima interacciÃ³n</span><span class="val">${c.ultimaInteraccion||'â€”'}</span></div>
      <div class="fila"><span class="key">ğŸ”” Estado</span><span class="val">${badgeHtml(estado)}</span></div>
    </div>
  `;

  const tel=c.telefono?.replace(/\D/g,'');
  const n=tel?.length===10?'52'+tel:tel;
  document.getElementById('btn-wa-ficha').onclick=()=>window.open(`https://wa.me/${n}`,'_blank');

  // Citas del cliente
  const citas=citasLocales.filter(ct=>ct.idCliente===c.idCliente);
  const divCitas=document.getElementById('ficha-citas');
  divCitas.innerHTML=!citas.length
    ? `<div class="empty"><div class="ico">ğŸ“­</div><p>Sin citas agendadas para este cliente</p></div>`
    : `<div class="tabla-wrap"><table>
        <thead><tr><th>ID</th><th>Fecha</th><th>Modalidad</th><th>Estado</th><th>Asesor</th><th></th></tr></thead>
        <tbody>${citas.map(ct=>`<tr>
          <td><span class="id-tag">${ct.id}</span></td>
          <td>${fmtFecha(ct.fecha)}</td>
          <td>${ct.modalidad||'â€”'}</td>
          <td>${badgeHtml(ct.estado)}</td>
          <td>${ct.asesor||'â€”'}</td>
          <td><button class="btn btn-ghost btn-sm" onclick="verCita('${ct.id}')">ğŸ‘ï¸</button></td>
        </tr>`).join('')}</tbody>
      </table></div>`;

  document.getElementById('ficha-simulaciones').innerHTML=`
    <div class="alerta alerta-info" style="margin-top:0">
      <span>â„¹ï¸</span>
      <div>Este cliente tiene <strong>${c.cantidadSimulaciones||0} simulaciones</strong> registradas en Google Sheets.<br>
      <small>Para ver detalles completos, consulta la hoja "Simulaciones" filtrando por ID: <strong>${c.idCliente}</strong></small></div>
    </div>
  `;
  toast('Ficha cargada','ok');
}

function agendarDesdeficha(){
  if(!clienteActual) return;
  document.querySelector('.tab-btn[onclick*="agendar"]').click();
  document.getElementById('buscar-tel').value=clienteActual.telefono||'';
  mostrarCliente(clienteActual);
  window.scrollTo({top:0,behavior:'smooth'});
}

function waCliente(tel){
  const t=tel?.replace(/\D/g,'');
  const n=t?.length===10?'52'+t:t;
  window.open(`https://wa.me/${n}`,'_blank');
}

// =====================================================
// TAB 5 â€” NOTIFICACIONES
// =====================================================
function actualizarPlantilla(){
  const tipo=document.getElementById('notif-tipo').value;
  if(tipo==='personalizado') return;

  const nombre=document.getElementById('notif-nombre').value||'Cliente';
  const capital=document.getElementById('notif-capital').value;
  const dias=document.getElementById('notif-dias').value;
  const pago=document.getElementById('notif-pago').value;
  const total=document.getElementById('notif-total').value;
  const fecha=document.getElementById('notif-fecha-cita').value;
  const lugar=document.getElementById('notif-lugar').value;

  let msg='';
  if(tipo==='confirmacion') msg=[
    `âœ… *CONFIRMACIÃ“N DE ENTREVISTA*`,``,
    `Hola *${nombre}*, su cita con SimPrÃ©stamo estÃ¡ confirmada.`,``,
    fecha?`ğŸ“… *Fecha:* ${fmtFecha(fecha)}`:'',
    lugar?`ğŸ“ *Lugar:* ${lugar}`:'',``,
    `Documentos necesarios:`,
    `â€¢ IdentificaciÃ³n oficial (INE)`,
    `â€¢ Comprobante de domicilio reciente`,
    `â€¢ Comprobante de ingresos`,``,
    `Â¿Alguna duda? Responda este mensaje.`,``,
    `_SimPrÃ©stamo â€” ${new Date().toLocaleDateString('es-MX')}_`
  ].filter(Boolean).join('\n');

  else if(tipo==='recordatorio') msg=[
    `â° *RECORDATORIO â€” ENTREVISTA MAÃ‘ANA*`,``,
    `Hola *${nombre}*, le recordamos su cita de maÃ±ana con SimPrÃ©stamo.`,``,
    fecha?`ğŸ“… *Fecha:* ${fmtFecha(fecha)}`:'',
    lugar?`ğŸ“ *Lugar:* ${lugar}`:'',``,
    `No olvide sus documentos:`,
    `â€¢ INE vigente`,
    `â€¢ Comprobante de domicilio`,
    `â€¢ Comprobante de ingresos`,``,
    `_SimPrÃ©stamo_`
  ].filter(Boolean).join('\n');

  else if(tipo==='resultado') msg=[
    `ğŸ’° *RESULTADO DE SU SIMULACIÃ“N DE PRÃ‰STAMO*`,``,
    `Hola *${nombre}*, aquÃ­ el resumen de su solicitud:`,``,
    capital?`ğŸ’µ *Capital solicitado:* ${fmt(capital)}`:'',
    dias?`ğŸ“… *Plazo:* ${dias} dÃ­as`:'',
    pago?`ğŸ—“ï¸ *Pago diario:* ${fmt(pago)}`:'',
    total?`ğŸ’¸ *Total a pagar:* ${fmt(total)}`:'',``,
    `Â¿Le interesa continuar? Agendemos una entrevista.`,``,
    fecha?`ğŸ“… *Cita propuesta:* ${fmtFecha(fecha)}`:'',
    lugar?`ğŸ“ *Lugar:* ${lugar}`:'',``,
    `_SimPrÃ©stamo â€” ${new Date().toLocaleDateString('es-MX')}_`
  ].filter(Boolean).join('\n');

  else if(tipo==='reprogramar') msg=[
    `ğŸ“… *CITA REPROGRAMADA*`,``,
    `Hola *${nombre}*, su entrevista con SimPrÃ©stamo ha sido reprogramada.`,``,
    fecha?`ğŸ“… *Nueva fecha:* ${fmtFecha(fecha)}`:'',
    lugar?`ğŸ“ *Lugar:* ${lugar}`:'',``,
    `Por favor confirme su asistencia respondiendo este mensaje.`,``,
    `_SimPrÃ©stamo_`
  ].filter(Boolean).join('\n');

  document.getElementById('notif-preview').value=msg;

  const mostrarSim=['resultado','confirmacion','reprogramar'].includes(tipo);
  document.getElementById('notif-sim-datos').style.display=mostrarSim?'block':'none';
}

function enviarNotifWA(){
  const tel=document.getElementById('notif-tel').value.trim();
  const msg=document.getElementById('notif-preview').value;
  const nombre=document.getElementById('notif-nombre').value;
  if(!tel){ toast('Ingresa el telÃ©fono del cliente','err'); return; }
  if(!msg){ toast('El mensaje estÃ¡ vacÃ­o. Selecciona un tipo o escribe el mensaje.','err'); return; }
  const t=tel.replace(/\D/g,'');
  const n=t.length===10?'52'+t:t;
  window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`,'_blank');
  registrarLog('WhatsApp',`Mensaje enviado a ${nombre||tel}`,'manual');
  toast('ğŸ“± WhatsApp abierto','ok');
}

function enviarNotifEmail(){
  const email=document.getElementById('notif-email').value.trim();
  const nombre=document.getElementById('notif-nombre').value;
  const msg=document.getElementById('notif-preview').value;
  if(!email){ toast('Ingresa el correo del cliente','err'); return; }
  const asunto=encodeURIComponent(`SimPrÃ©stamo â€” InformaciÃ³n para ${nombre}`);
  const cuerpo=encodeURIComponent(msg);
  window.open(`mailto:${email}?subject=${asunto}&body=${cuerpo}`,'_blank');
  registrarLog('Email',`Email enviado a ${nombre||email}`,'manual');
  toast('ğŸ“§ Cliente de correo abierto','ok');
}

function registrarLog(canal, desc, ref){
  logNotif.unshift({ fecha:new Date().toISOString(), canal, desc, ref });
  lsSet(LOG_KEY, logNotif.slice(0,50));
  renderLog();
}

function renderLog(){
  const div=document.getElementById('log-notificaciones');
  if(!logNotif.length){
    div.innerHTML=`<div class="empty"><div class="ico">ğŸ“­</div><p>Sin notificaciones enviadas</p></div>`;
    return;
  }
  div.innerHTML=logNotif.slice(0,20).map(l=>`
    <div class="sim-box" style="margin-bottom:8px;padding:10px 14px">
      <div class="sim-row">
        <span class="sk">${l.canal==='WhatsApp'?'ğŸ“±':'ğŸ“§'} ${l.canal}</span>
        <span class="sv" style="font-size:.75rem;color:var(--texto)">${new Date(l.fecha).toLocaleString('es-MX')}</span>
      </div>
      <div style="font-size:.83rem;color:var(--texto);margin-top:4px">${l.desc}</div>
    </div>
  `).join('');
}

// =====================================================
// INIT
// =====================================================
// Restaurar URL
const urlGuardada=lsGet(URL_KEY,'');
if(urlGuardada) document.getElementById('url-script').value=urlGuardada;
document.getElementById('url-script').addEventListener('change',function(){ lsSet(URL_KEY,this.value) });

// Cerrar modal con click fuera
window.addEventListener('click',e=>{ if(e.target===document.getElementById('modal-editar')) cerrarModal() });

// Init
actualizarPlantilla();
renderLog();
actualizarStats();
renderCalendario();
document.getElementById('cita-fecha').min=fechaAhora();
document.getElementById('notif-fecha-cita').min=fechaAhora();

console.log('âœ… SimPrÃ©stamo Agenda cargada');
</script>
</body>
</html>
