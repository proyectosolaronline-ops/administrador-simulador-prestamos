<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>SimPr√©stamo ‚Äî Agenda</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
/* ======================================================
   VARIABLES & RESET
====================================================== */
:root{
  --v:#00e5b0; --v2:#00c49a; --v3:rgba(0,229,176,.08);
  --a:#0f4c81; --a2:#1a6db5; --a3:rgba(15,76,129,.15);
  --bg:#07101e; --bg2:#0c1d30; --bg3:#102038; --bg4:#152844;
  --bd:#1e3a58; --bd2:rgba(30,58,88,.6);
  --tx:#a8c8e8; --wh:#e8f4ff;
  --rd:#ff4d6d; --am:#ffc107; --or:#ff8c42; --wa:#25d366;
  --r:14px; --r2:10px; --r3:8px;
  --sh:0 8px 32px rgba(0,0,0,.45);
  --tr:.2s ease;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{scroll-behavior:smooth;-webkit-text-size-adjust:100%}
body{
  font-family:'DM Sans',sans-serif;
  background:var(--bg);color:var(--tx);
  min-height:100vh;min-height:100dvh;
  overflow-x:hidden;
  padding-bottom:80px; /* espacio para nav bottom */
}
body::before{
  content:'';position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 80% 50% at 0% 0%,rgba(0,229,176,.06) 0%,transparent 60%),
    radial-gradient(ellipse 60% 40% at 100% 100%,rgba(15,76,129,.1) 0%,transparent 60%);
}

/* ======================================================
   TOPBAR
====================================================== */
.topbar{
  position:sticky;top:0;z-index:300;
  background:rgba(7,16,30,.97);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--bd);
  display:flex;align-items:center;gap:10px;
  padding:0 16px;height:56px;
}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.1rem;color:var(--v);flex:1}
.logo span{color:var(--wh)}
.chip{font-size:.68rem;font-weight:700;padding:3px 9px;border-radius:20px;white-space:nowrap;letter-spacing:.03em}
.chip-wa{background:rgba(37,211,102,.12);border:1px solid rgba(37,211,102,.28);color:var(--wa)}
.chip-ok{background:rgba(0,229,176,.1);border:1px solid rgba(0,229,176,.25);color:var(--v)}

/* ======================================================
   BOTTOM NAV (mobile principal)
====================================================== */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;z-index:300;
  background:rgba(7,16,30,.98);backdrop-filter:blur(20px);
  border-top:1px solid var(--bd);
  display:flex;align-items:stretch;
  height:64px;padding:0 4px;
  safe-area-inset-bottom:env(safe-area-inset-bottom);
  padding-bottom:env(safe-area-inset-bottom);
}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;border:none;background:transparent;color:var(--tx);
  font-family:'DM Sans',sans-serif;font-size:.6rem;font-weight:600;
  cursor:pointer;border-radius:10px;margin:4px 2px;
  transition:all var(--tr);letter-spacing:.02em;
  padding:6px 2px;
}
.nav-item .nav-ico{font-size:1.25rem;line-height:1;transition:transform var(--tr)}
.nav-item:hover{color:var(--wh)}
.nav-item.activo{
  color:var(--v);
  background:rgba(0,229,176,.08);
}
.nav-item.activo .nav-ico{transform:scale(1.15)}

/* ======================================================
   APP CONTAINER
====================================================== */
.app{
  position:relative;z-index:1;
  max-width:560px;margin:0 auto;
  padding:14px 12px 20px;
}

/* ======================================================
   SECCIONES
====================================================== */
.seccion{display:none;animation:fadeUp .25s ease both}
.seccion.visible{display:block}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* ======================================================
   CARDS
====================================================== */
.card{
  background:var(--bg3);border:1px solid var(--bd);
  border-radius:var(--r);padding:16px;
  box-shadow:var(--sh);margin-bottom:14px;
}
.card-titulo{
  font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:var(--wh);
  margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.card-titulo::after{content:'';flex:1;height:1px;background:linear-gradient(to right,var(--bd),transparent)}

/* ======================================================
   STATS GRID
====================================================== */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px}
.stat-card{
  background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r2);
  padding:12px 8px;text-align:center;
}
.stat-card .st-ico{font-size:1.2rem;margin-bottom:4px}
.stat-card .st-num{font-family:'Syne',sans-serif;font-size:1.4rem;font-weight:800;color:var(--wh);line-height:1}
.stat-card .st-lbl{font-size:.58rem;color:var(--tx);opacity:.65;margin-top:3px;text-transform:uppercase;letter-spacing:.04em}

/* ======================================================
   CAMPOS / FORMS
====================================================== */
.campo{display:flex;flex-direction:column;gap:5px;margin-bottom:12px}
.campo label{font-size:.7rem;font-weight:700;color:var(--v);text-transform:uppercase;letter-spacing:.07em}
.campo input,.campo select,.campo textarea{
  background:rgba(255,255,255,.05);border:1px solid var(--bd);
  border-radius:var(--r3);color:var(--wh);
  font-family:'DM Sans',sans-serif;font-size:.95rem;
  padding:11px 13px;outline:none;width:100%;
  transition:border-color var(--tr),background var(--tr);
  -webkit-appearance:none;appearance:none;
}
.campo input:focus,.campo select:focus,.campo textarea:focus{
  border-color:var(--v);background:rgba(0,229,176,.04);
}
.campo select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2300e5b0' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.campo select option{background:var(--bg3);color:var(--wh)}
.campo textarea{resize:vertical;min-height:80px}
.campo input[type="datetime-local"]::-webkit-calendar-picker-indicator{filter:invert(.5) sepia(1) saturate(3) hue-rotate(120deg)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}

/* ======================================================
   BOTONES
====================================================== */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:6px;
  padding:12px 20px;border-radius:var(--r2);
  font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:600;
  border:none;cursor:pointer;transition:all var(--tr);
  white-space:nowrap;min-height:44px;
}
.btn:disabled{opacity:.35;cursor:not-allowed}
.btn:active:not(:disabled){transform:scale(.97)}
.btn-primary{background:linear-gradient(135deg,var(--v),var(--v2));color:var(--bg)}
.btn-primary:hover:not(:disabled){box-shadow:0 6px 20px rgba(0,229,176,.3)}
.btn-azul{background:linear-gradient(135deg,var(--a),var(--a2));color:#fff}
.btn-azul:hover:not(:disabled){box-shadow:0 6px 20px rgba(15,76,129,.35)}
.btn-wa{background:linear-gradient(135deg,#25d366,#1ebe5d);color:#fff}
.btn-wa:hover:not(:disabled){box-shadow:0 6px 20px rgba(37,211,102,.35)}
.btn-rojo{background:rgba(255,77,109,.15);border:1px solid rgba(255,77,109,.3);color:var(--rd)}
.btn-ghost{background:rgba(255,255,255,.06);border:1px solid var(--bd);color:var(--tx)}
.btn-ghost:hover:not(:disabled){background:rgba(255,255,255,.1);color:var(--wh)}
.btn-sm{padding:8px 14px;font-size:.78rem;min-height:36px}
.btn-full{width:100%}
.fila-btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px}

/* ======================================================
   LISTA DE SIMULACIONES ‚Äî filas densas tipo celda
====================================================== */
.sim-card-list{
  border:1px solid var(--bd);border-radius:var(--r2);overflow:hidden;
}
/* cabecera */
.sim-list-head{
  display:grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 64px;
  gap:0;
  background:var(--a);
  padding:7px 10px;
}
.sim-list-head span{
  font-family:'Syne',sans-serif;font-size:.62rem;font-weight:700;
  color:rgba(255,255,255,.8);text-transform:uppercase;letter-spacing:.05em;
}
/* fila */
.sim-card-item{
  display:grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 64px;
  gap:0;align-items:center;
  padding:9px 10px;
  cursor:pointer;
  border-bottom:1px solid var(--bd2);
  background:var(--bg3);
  transition:background var(--tr);
  position:relative;
}
.sim-card-item:last-child{border-bottom:none}
.sim-card-item::before{
  content:'';position:absolute;left:0;top:0;bottom:0;width:2px;
  background:transparent;transition:background var(--tr);
}
.sim-card-item:hover{background:rgba(0,229,176,.04)}
.sim-card-item:hover::before{background:var(--v)}
.sim-card-item:active{background:rgba(0,229,176,.07)}
/* celdas */
.sc-nombre{
  font-size:.82rem;font-weight:600;color:var(--wh);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;padding-right:8px;
}
.sc-sub{font-size:.65rem;color:var(--tx);opacity:.55;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sc-val{font-size:.8rem;font-weight:700;white-space:nowrap}
.sc-val.verde{color:var(--v)}
.sc-val.amarillo{color:var(--am)}
.sc-val.gris{color:var(--tx)}
.sc-badge{display:flex;flex-direction:column;gap:3px;align-items:flex-end}
.sc-ico{font-size:.75rem;color:var(--v);opacity:.6;text-align:right;padding-left:4px}

/* ======================================================
   BADGES
====================================================== */
.badge{display:inline-flex;align-items:center;gap:3px;font-size:.67rem;font-weight:700;padding:3px 8px;border-radius:20px;white-space:nowrap}
.badge-p{background:rgba(255,193,7,.12);border:1px solid rgba(255,193,7,.3);color:var(--am)}
.badge-ok{background:rgba(0,229,176,.12);border:1px solid rgba(0,229,176,.28);color:var(--v)}
.badge-az{background:rgba(26,109,181,.15);border:1px solid rgba(26,109,181,.3);color:#7ab8f5}
.badge-rd{background:rgba(255,77,109,.12);border:1px solid rgba(255,77,109,.3);color:var(--rd)}

/* ======================================================
   INFO ROWS (detalle)
====================================================== */
.info-box{background:var(--v3);border:1px solid rgba(0,229,176,.18);border-radius:var(--r2);padding:12px 14px;margin-bottom:10px}
.info-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;font-size:.85rem;border-bottom:1px solid rgba(255,255,255,.04)}
.info-row:last-child{border:none;padding-bottom:0}
.info-row .ik{color:var(--tx);opacity:.7;font-size:.78rem}
.info-row .iv{color:var(--wh);font-weight:600;text-align:right;max-width:60%;font-size:.85rem}
.calc-box{background:var(--a3);border:1px solid rgba(26,109,181,.25);border-radius:var(--r2);padding:12px 14px}
.calc-row{display:flex;justify-content:space-between;padding:5px 0;font-size:.85rem;border-bottom:1px solid rgba(255,255,255,.04)}
.calc-row:last-child{border:none;padding-bottom:0}
.calc-row .ck{color:var(--tx);opacity:.7;font-size:.78rem}
.calc-row .cv{color:var(--v);font-weight:700}

/* ======================================================
   ID TAG
====================================================== */
.id-tag{
  font-size:.67rem;background:rgba(0,229,176,.1);border:1px solid rgba(0,229,176,.2);
  color:var(--v);border-radius:6px;padding:2px 7px;display:inline-block;
  font-family:'DM Sans',sans-serif;font-weight:600;letter-spacing:.02em;
}

/* ======================================================
   CITAS ‚Äî lista mobile
====================================================== */
.cita-item{
  background:var(--bg3);border:1px solid var(--bd);border-radius:var(--r);
  padding:14px;margin-bottom:10px;cursor:pointer;
  transition:border-color var(--tr);
}
.cita-item:hover{border-color:rgba(0,229,176,.25)}
.cita-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
.cita-nombre{font-weight:700;color:var(--wh);font-size:.92rem}
.cita-meta{display:flex;gap:8px;flex-wrap:wrap;font-size:.75rem;color:var(--tx);margin-bottom:8px;opacity:.8}
.cita-acciones{display:flex;gap:6px}

/* ======================================================
   SEARCH BAR
====================================================== */
.search-bar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.search-input{
  flex:1;min-width:0;background:rgba(255,255,255,.05);border:1px solid var(--bd);
  border-radius:var(--r3);color:var(--wh);font-family:'DM Sans',sans-serif;
  font-size:.88rem;padding:10px 13px;outline:none;-webkit-appearance:none;
}
.search-input:focus{border-color:var(--v)}
.search-select{background:rgba(255,255,255,.05);border:1px solid var(--bd);border-radius:var(--r3);color:var(--wh);font-family:'DM Sans',sans-serif;font-size:.82rem;padding:10px 10px;outline:none;-webkit-appearance:none;appearance:none}
.search-select option{background:var(--bg3)}

/* ======================================================
   MODAL / POPUP
====================================================== */
.modal-overlay{
  position:fixed;inset:0;z-index:500;
  background:rgba(0,0,0,.75);backdrop-filter:blur(6px);
  display:flex;align-items:flex-end;justify-content:center;
  padding:0;opacity:0;pointer-events:none;
  transition:opacity .25s ease;
}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{
  background:var(--bg3);
  border:1px solid var(--bd);
  border-radius:22px 22px 0 0;
  padding:0;width:100%;max-width:560px;
  max-height:92dvh;
  display:flex;flex-direction:column;
  transform:translateY(100%);
  transition:transform .3s cubic-bezier(.32,.72,0,1);
  overflow:hidden;
}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-handle{
  width:40px;height:4px;background:var(--bd);border-radius:2px;
  margin:12px auto 0;flex-shrink:0;
}
.modal-header{
  display:flex;align-items:center;justify-content:space-between;
  padding:16px 18px 12px;border-bottom:1px solid var(--bd);flex-shrink:0;
}
.modal-header h2{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--wh)}
.btn-cerrar{
  background:rgba(255,255,255,.08);border:none;color:var(--tx);
  font-size:1rem;cursor:pointer;padding:6px 10px;border-radius:8px;
  transition:all var(--tr);line-height:1;
}
.btn-cerrar:hover{color:var(--wh);background:rgba(255,255,255,.15)}
.modal-body{overflow-y:auto;padding:16px 18px 24px;flex:1;-webkit-overflow-scrolling:touch}
.modal-footer{
  padding:14px 18px;border-top:1px solid var(--bd);flex-shrink:0;
  background:var(--bg3);
  padding-bottom:calc(14px + env(safe-area-inset-bottom));
}

/* MODAL SIM ‚Äî highlight de montos */
.monto-grande{
  font-family:'Syne',sans-serif;font-size:1.6rem;font-weight:800;
  color:var(--v);text-align:center;margin:10px 0;
}
.monto-sub{font-size:.75rem;color:var(--tx);text-align:center;opacity:.7;margin-bottom:14px}
.monto-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.monto-chip{
  background:var(--a3);border:1px solid rgba(26,109,181,.25);border-radius:var(--r2);
  padding:10px;text-align:center;
}
.monto-chip .mc-val{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--wh)}
.monto-chip .mc-lbl{font-size:.65rem;color:var(--tx);opacity:.65;text-transform:uppercase;letter-spacing:.04em;margin-top:3px}

/* ======================================================
   CALENDARIO
====================================================== */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.cal-header h3{font-family:'Syne',sans-serif;font-size:.92rem;color:var(--wh)}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cal-day-name{text-align:center;font-size:.62rem;font-weight:700;color:var(--tx);opacity:.45;padding:5px 0;text-transform:uppercase}
.cal-day{
  text-align:center;padding:7px 2px;border-radius:8px;font-size:.8rem;
  cursor:pointer;transition:background var(--tr);color:var(--tx);position:relative;
}
.cal-day:hover:not(.vacio){background:rgba(255,255,255,.07)}
.cal-day.hoy{background:var(--a);color:#fff;font-weight:700}
.cal-day.con-citas::after{
  content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);
  width:4px;height:4px;border-radius:50%;background:var(--v);
}
.cal-day.seleccionado{background:rgba(0,229,176,.18);border:1px solid rgba(0,229,176,.35);color:var(--v)}
.cal-day.vacio{cursor:default}

/* ======================================================
   ALERTA
====================================================== */
.alerta{border-radius:var(--r2);padding:11px 14px;font-size:.82rem;display:flex;align-items:flex-start;gap:9px;margin-bottom:12px}
.alerta-info{background:rgba(26,109,181,.1);border:1px solid rgba(26,109,181,.25);color:#7ab8f5}
.alerta-ok{background:rgba(0,229,176,.08);border:1px solid rgba(0,229,176,.22);color:var(--v)}
.alerta-warn{background:rgba(255,193,7,.08);border:1px solid rgba(255,193,7,.25);color:var(--am)}

/* ======================================================
   EMPTY
====================================================== */
.empty{text-align:center;padding:40px 20px;color:var(--tx);opacity:.45}
.empty .ico{font-size:2.4rem;margin-bottom:10px}
.empty p{font-size:.88rem}

/* ======================================================
   SEP
====================================================== */
.sep{height:1px;background:var(--bd);margin:14px 0}

/* ======================================================
   FICHA CLIENTE
====================================================== */
.cliente-box{background:var(--v3);border:1px solid rgba(0,229,176,.18);border-radius:var(--r2);padding:12px 14px;margin-bottom:10px}

/* ======================================================
   TOAST
====================================================== */
#toast-container{position:fixed;bottom:80px;right:12px;z-index:9999;display:flex;flex-direction:column;gap:7px;max-width:calc(100vw - 24px)}
.toast{
  background:var(--bg4);border:1px solid var(--bd);border-radius:var(--r2);
  padding:11px 14px;display:flex;align-items:center;gap:9px;
  animation:toastIn .28s ease;box-shadow:0 8px 28px rgba(0,0,0,.5);
  font-size:.84rem;transition:opacity .4s;
}
.toast.ok{border-left:3px solid var(--v)}
.toast.err{border-left:3px solid var(--rd)}
.toast.inf{border-left:3px solid var(--am)}
@keyframes toastIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}

/* ======================================================
   SCROLLBAR
====================================================== */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--bd);border-radius:2px}

/* ======================================================
   NOTIF PREVIEW
====================================================== */
.notif-preview{
  background:rgba(0,0,0,.2);border:1px solid var(--bd);border-radius:var(--r2);
  padding:12px;font-size:.8rem;font-family:monospace;line-height:1.55;
  color:var(--tx);white-space:pre-wrap;min-height:120px;
  resize:vertical;outline:none;width:100%;
}
.notif-preview:focus{border-color:var(--v)}

/* SPIN */
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:20px;height:20px;border:2px solid rgba(255,255,255,.15);border-top-color:var(--v);border-radius:50%;animation:spin .7s linear infinite;margin:0 auto}

/* ======================================================
   TABLA SIMPLE (solo para citas y clientes en desktop)
====================================================== */
@media(min-width:600px){
  .app{max-width:800px}
  .modal{border-radius:16px;margin:20px;max-height:88vh}
  .modal-overlay{align-items:center}
  .modal-handle{display:none}
  body{padding-bottom:0}
  .bottom-nav{display:none}
  /* Tabs top para desktop */
  .desktop-tabs{display:flex!important}
}
.desktop-tabs{
  display:none;gap:4px;background:var(--bg2);border:1px solid var(--bd);
  border-radius:var(--r);padding:5px;margin-bottom:16px;flex-wrap:wrap;
}
.desktop-tab-btn{
  flex:1;min-width:100px;padding:9px 12px;border:none;border-radius:var(--r2);
  background:transparent;color:var(--tx);font-family:'DM Sans',sans-serif;
  font-size:.82rem;font-weight:500;cursor:pointer;transition:all var(--tr);
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.desktop-tab-btn:hover{background:rgba(255,255,255,.05);color:var(--wh)}
.desktop-tab-btn.activo{
  background:linear-gradient(135deg,var(--a),var(--a2));
  color:#fff;font-weight:600;box-shadow:0 4px 14px rgba(15,76,129,.35);
}
</style>
</head>
<body>

<!-- ===================== TOPBAR ===================== -->
<div class="topbar">
  <div class="logo">Sim<span>Pr√©stamo</span></div>
</div>

<!-- ===================== APP ===================== -->
<div class="app">

  <!-- TABS DESKTOP -->
  <div class="desktop-tabs" id="desktop-tabs">
    <button class="desktop-tab-btn" onclick="cambiarTab('simulaciones',this)">üí∞ Simulaciones</button>
    <button class="desktop-tab-btn activo" onclick="cambiarTab('agendar',this)">üìÖ Agendar</button>
    <button class="desktop-tab-btn" onclick="cambiarTab('consultar',this)">üîç Mis Citas</button>
    <button class="desktop-tab-btn" onclick="cambiarTab('calendario',this)">üóìÔ∏è Calendario</button>
    <button class="desktop-tab-btn" onclick="cambiarTab('cliente',this)">üë§ Clientes</button>
    <button class="desktop-tab-btn" onclick="cambiarTab('notificaciones',this)">üîî Notif.</button>
  </div>

  <!-- ================================================
       TAB: SIMULACIONES
  ================================================ -->
  <div id="tab-simulaciones" class="seccion">

    <div class="card">
      <div class="card-titulo">üí∞ Simulaciones</div>

      <!-- STATS -->
      <div class="stats-row">
        <div class="stat-card"><div class="st-ico">üìä</div><div class="st-num" id="sim-stat-total">‚Äî</div><div class="st-lbl">Total</div></div>
        <div class="stat-card"><div class="st-ico">‚úÖ</div><div class="st-num" id="sim-stat-completo">‚Äî</div><div class="st-lbl">Completas</div></div>
        <div class="stat-card"><div class="st-ico">‚ö†Ô∏è</div><div class="st-num" id="sim-stat-nuevo">‚Äî</div><div class="st-lbl">Nuevas</div></div>
        <div class="stat-card"><div class="st-ico">üìÖ</div><div class="st-num" id="sim-stat-agendadas">‚Äî</div><div class="st-lbl">Con Cita</div></div>
      </div>

      <!-- B√öSQUEDA -->
      <div class="search-bar">
        <input class="search-input" id="filtro-sims" placeholder="üîç Buscar nombre, tel, ID..." oninput="filtrarSimulaciones()">
        <select class="search-select" id="filtro-sim-estado" onchange="filtrarSimulaciones()">
          <option value="">Todos</option>
          <option value="Completo">‚úÖ Completo</option>
          <option value="Nuevo">‚ö†Ô∏è Nuevo</option>
          <option value="Pendiente">‚è≥ Pendiente</option>
        </select>
        <button class="btn btn-azul btn-sm" onclick="cargarSimulaciones()">üîÑ</button>
      </div>

      <!-- LISTA DE CARDS -->
      <div class="sim-card-list" id="sim-card-list">
        <div class="empty"><div class="ico">üí∞</div><p>Presiona üîÑ para cargar simulaciones</p></div>
      </div>
    </div>
  </div>

  <!-- ================================================
       TAB: AGENDAR
  ================================================ -->
  <div id="tab-agendar" class="seccion visible">

    <div class="card">
      <div class="card-titulo">üîç Buscar Cliente</div>
      <div class="g2">
        <div class="campo">
          <label>Tel√©fono</label>
          <input type="tel" id="buscar-tel" placeholder="4421234567" oninput="limpiarCliente()">
        </div>
        <div class="campo">
          <label>ID Cliente</label>
          <input type="text" id="buscar-id" placeholder="CLI-...">
        </div>
      </div>
      <div class="fila-btns">
        <button class="btn btn-azul btn-full" onclick="buscarCliente()">üîç Buscar Cliente</button>
        <button class="btn btn-ghost btn-sm" onclick="limpiarBusqueda()">‚úï</button>
      </div>

      <div id="resultado-cliente" style="display:none;margin-top:14px">
        <div class="sep"></div>
        <div class="card-titulo" style="font-size:.88rem;margin-bottom:10px">‚úÖ Cliente Encontrado</div>
        <div id="cliente-info-box" class="cliente-box"></div>
        <div id="citas-previas" style="display:none;margin-top:12px">
          <div style="font-size:.7rem;font-weight:700;color:var(--v);margin-bottom:8px;text-transform:uppercase;letter-spacing:.06em">üìã Citas previas</div>
          <div id="lista-citas-previas"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-titulo">üìÖ Datos de la Entrevista</div>

      <div class="campo">
        <label>Fecha y Hora *</label>
        <input type="datetime-local" id="cita-fecha">
      </div>
      <div class="g2">
        <div class="campo">
          <label>Modalidad</label>
          <select id="cita-modalidad">
            <option value="Presencial">üìç Presencial</option>
            <option value="WhatsApp">üì± WhatsApp</option>
            <option value="Llamada">üìû Llamada</option>
            <option value="Videollamada">üíª Video</option>
          </select>
        </div>
        <div class="campo">
          <label>Duraci√≥n</label>
          <select id="cita-duracion">
            <option value="15">15 min</option>
            <option value="30" selected>30 min</option>
            <option value="45">45 min</option>
            <option value="60">1 hora</option>
          </select>
        </div>
      </div>
      <div class="campo">
        <label>Lugar / Direcci√≥n</label>
        <input type="text" id="cita-lugar" placeholder="Ej: Oficina Quer√©taro">
      </div>
      <div class="campo">
        <label>Asesor Responsable</label>
        <input type="text" id="cita-asesor" placeholder="Nombre del asesor">
      </div>
      <div class="campo">
        <label>Notas</label>
        <textarea id="cita-notas" placeholder="Revisar documentaci√≥n, confirmar datos..."></textarea>
      </div>
      <div class="campo">
        <label>ID Simulaci√≥n vinculada (opcional)</label>
        <input type="text" id="cita-sim-id" placeholder="SIM-...">
      </div>

      <div class="fila-btns">
        <button class="btn btn-primary btn-full" onclick="agendarCita()">üìÖ Agendar Entrevista</button>
      </div>
      <div class="fila-btns">
        <button class="btn btn-wa" id="btn-wa-confirm" disabled onclick="notificarWhatsApp()" style="flex:1">üì± Notificar WA</button>
        <button class="btn btn-ghost btn-sm" onclick="limpiarFormCita()">üîÑ</button>
      </div>
    </div>
  </div>

  <!-- ================================================
       TAB: MIS CITAS
  ================================================ -->
  <div id="tab-consultar" class="seccion">

    <div class="stats-row" style="margin-bottom:14px">
      <div class="stat-card"><div class="st-ico">üìÖ</div><div class="st-num" id="stat-total">0</div><div class="st-lbl">Total</div></div>
      <div class="stat-card"><div class="st-ico">‚è≥</div><div class="st-num" id="stat-pendientes">0</div><div class="st-lbl">Pend.</div></div>
      <div class="stat-card"><div class="st-ico">üéØ</div><div class="st-num" id="stat-realizadas">0</div><div class="st-lbl">Realiz.</div></div>
      <div class="stat-card"><div class="st-ico">‚ùå</div><div class="st-num" id="stat-canceladas">0</div><div class="st-lbl">Canc.</div></div>
    </div>

    <div class="card">
      <div class="card-titulo">üìã Entrevistas</div>
      <div class="search-bar">
        <input class="search-input" id="filtro-citas" placeholder="üîç Buscar..." oninput="filtrarCitas()">
        <select class="search-select" id="filtro-estado" onchange="filtrarCitas()">
          <option value="">Todos</option>
          <option value="Pendiente">‚è≥ Pendiente</option>
          <option value="Confirmada">‚úÖ Confirmada</option>
          <option value="Realizada">üéØ Realizada</option>
          <option value="Cancelada">‚ùå Cancelada</option>
        </select>
        <button class="btn btn-azul btn-sm" onclick="cargarCitas()">üîÑ</button>
        <button class="btn btn-ghost btn-sm" onclick="exportarCSV()">‚¨áÔ∏è</button>
      </div>
      <div id="lista-citas">
        <div class="empty"><div class="ico">üì≠</div><p>Presiona üîÑ para cargar citas</p></div>
      </div>
    </div>
  </div>

  <!-- ================================================
       TAB: CALENDARIO
  ================================================ -->
  <div id="tab-calendario" class="seccion">
    <div class="card">
      <div class="card-titulo">üóìÔ∏è Calendario</div>
      <div class="cal-header">
        <button class="btn btn-ghost btn-sm" onclick="navMes(-1)">‚óÄ</button>
        <h3 id="cal-mes-titulo"></h3>
        <button class="btn btn-ghost btn-sm" onclick="navMes(1)">‚ñ∂</button>
      </div>
      <div class="cal-grid" id="cal-grid"></div>
      <div style="margin-top:10px;display:flex;gap:12px;font-size:.7rem;color:var(--tx);opacity:.6">
        <span>‚óè verde = citas</span><span style="color:var(--a2)">‚ñ† azul = hoy</span>
      </div>
    </div>
    <div class="card">
      <div class="card-titulo">üìÖ Citas del d√≠a</div>
      <div id="citas-dia"><div class="empty"><div class="ico">üëÜ</div><p>Selecciona un d√≠a</p></div></div>
    </div>
  </div>

  <!-- ================================================
       TAB: FICHA CLIENTE
  ================================================ -->
  <div id="tab-cliente" class="seccion">
    <div class="card">
      <div class="card-titulo">üë§ Buscar Cliente</div>
      <div class="campo">
        <label>Tel√©fono o ID Cliente</label>
        <input type="text" id="ficha-buscar" placeholder="4421234567 o CLI-...">
      </div>
      <div class="fila-btns">
        <button class="btn btn-azul" onclick="buscarFichaCliente()" style="flex:1">üîç Ver Ficha</button>
        <button class="btn btn-ghost" onclick="cargarTodosClientes()" style="flex:1">üë• Ver Todos</button>
      </div>
    </div>

    <div id="ficha-resultado" style="display:none">
      <div class="card">
        <div class="card-titulo">üë§ Datos del Cliente</div>
        <div id="ficha-datos"></div>
        <div class="fila-btns">
          <button class="btn btn-wa" id="btn-wa-ficha" style="flex:1">üì± WhatsApp</button>
          <button class="btn btn-azul" onclick="agendarDesdeficha()" style="flex:1">üìÖ Agendar</button>
        </div>
      </div>
      <div class="card">
        <div class="card-titulo">üìä Simulaciones</div>
        <div id="ficha-simulaciones"></div>
      </div>
      <div class="card">
        <div class="card-titulo">üìÖ Historial de Citas</div>
        <div id="ficha-citas"></div>
      </div>
    </div>

    <div id="todos-clientes" style="display:none">
      <div class="card">
        <div class="card-titulo">üë• Todos los Clientes</div>
        <div class="campo">
          <input class="search-input" id="filtro-clientes" placeholder="üîç Buscar..." oninput="filtrarClientes()" style="margin-bottom:0">
        </div>
        <div id="lista-clientes" style="margin-top:12px"></div>
      </div>
    </div>
  </div>

  <!-- ================================================
       TAB: NOTIFICACIONES
  ================================================ -->
  <div id="tab-notificaciones" class="seccion">
    <div class="card">
      <div class="card-titulo">üì¨ Notificaci√≥n al Cliente</div>
      <div class="g2">
        <div class="campo">
          <label>Nombre</label>
          <input type="text" id="notif-nombre" placeholder="Mar√≠a Garc√≠a">
        </div>
        <div class="campo">
          <label>Tel√©fono WA</label>
          <input type="tel" id="notif-tel" placeholder="4421234567">
        </div>
      </div>
      <div class="campo">
        <label>Correo</label>
        <input type="email" id="notif-email" placeholder="cliente@correo.com">
      </div>
      <div class="campo">
        <label>Tipo de mensaje</label>
        <select id="notif-tipo" onchange="actualizarPlantilla()">
          <option value="confirmacion">‚úÖ Confirmaci√≥n de cita</option>
          <option value="recordatorio">‚è∞ Recordatorio 24h</option>
          <option value="resultado">üí∞ Resultado simulaci√≥n</option>
          <option value="reprogramar">üìÖ Cita reprogramada</option>
          <option value="personalizado">‚úèÔ∏è Personalizado</option>
        </select>
      </div>

      <div id="notif-sim-datos">
        <div class="sep"></div>
        <div style="font-size:.7rem;font-weight:700;color:var(--v);margin-bottom:10px;text-transform:uppercase;letter-spacing:.06em">üí∞ Datos del pr√©stamo</div>
        <div class="g2">
          <div class="campo"><label>Capital</label><input type="number" id="notif-capital" placeholder="5000"></div>
          <div class="campo"><label>D√≠as</label><input type="number" id="notif-dias" placeholder="27"></div>
          <div class="campo"><label>Pago diario</label><input type="number" id="notif-pago" placeholder="225"></div>
          <div class="campo"><label>Total</label><input type="number" id="notif-total" placeholder="6075"></div>
        </div>
        <div class="g2">
          <div class="campo"><label>Fecha cita</label><input type="datetime-local" id="notif-fecha-cita"></div>
          <div class="campo"><label>Lugar</label><input type="text" id="notif-lugar" placeholder="Oficina QRO"></div>
        </div>
      </div>

      <div class="campo" style="margin-top:4px">
        <label>Vista previa (editable)</label>
        <textarea class="notif-preview" id="notif-preview" rows="10"></textarea>
      </div>

      <div class="fila-btns">
        <button class="btn btn-wa" onclick="enviarNotifWA()" style="flex:1">üì± WhatsApp</button>
        <button class="btn btn-primary" onclick="enviarNotifEmail()" style="flex:1">üìß Email</button>
        <button class="btn btn-ghost btn-sm" onclick="actualizarPlantilla()">üîÑ</button>
      </div>
    </div>

    <div class="card">
      <div class="card-titulo">üìã Historial (sesi√≥n)</div>
      <div id="log-notificaciones"><div class="empty"><div class="ico">üì≠</div><p>Sin notificaciones a√∫n</p></div></div>
    </div>
  </div>

</div><!-- /app -->

<!-- ===================== BOTTOM NAV ===================== -->
<nav class="bottom-nav">
  <button class="nav-item" onclick="cambiarTab('simulaciones',this)" data-tab="simulaciones">
    <span class="nav-ico">üí∞</span>Sims
  </button>
  <button class="nav-item activo" onclick="cambiarTab('agendar',this)" data-tab="agendar">
    <span class="nav-ico">üìÖ</span>Agendar
  </button>
  <button class="nav-item" onclick="cambiarTab('consultar',this)" data-tab="consultar">
    <span class="nav-ico">üîç</span>Citas
  </button>
  <button class="nav-item" onclick="cambiarTab('calendario',this)" data-tab="calendario">
    <span class="nav-ico">üóìÔ∏è</span>Cal.
  </button>
  <button class="nav-item" onclick="cambiarTab('cliente',this)" data-tab="cliente">
    <span class="nav-ico">üë§</span>Clientes
  </button>
  <button class="nav-item" onclick="cambiarTab('notificaciones',this)" data-tab="notificaciones">
    <span class="nav-ico">üîî</span>Notif.
  </button>
</nav>

<!-- ===================== MODAL SIMULACI√ìN ===================== -->
<div class="modal-overlay" id="modal-sim">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2 id="modal-sim-titulo">üí∞ Simulaci√≥n</h2>
      <button class="btn-cerrar" onclick="cerrarModalSim()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-sim-body"></div>
    <div class="modal-footer" id="modal-sim-footer"></div>
  </div>
</div>

<!-- ===================== MODAL CITA ===================== -->
<div class="modal-overlay" id="modal-cita">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <h2>üìã Detalle de Cita</h2>
      <button class="btn-cerrar" onclick="cerrarModalCita()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-cita-body"></div>
    <div class="modal-footer" id="modal-cita-footer"></div>
  </div>
</div>

<!-- ===================== TOAST ===================== -->
<div id="toast-container"></div>

<script>
// ======================================================
// CONFIG INTERNA
// ======================================================
const GAS_URL = 'https://script.google.com/macros/s/AKfycbw83md07bzx1UmGRn51i-pRiuvQaEig_mUWS4VjvO0yTIlDCULqT8p3NGsSe2S4nZhzjA/exec';
const CITAS_KEY = 'simprestamo_citas_v2';
const LOG_KEY   = 'simprestamo_log_v1';

// ESTADO GLOBAL
let clienteActual    = null;
let citasLocales     = lsGet(CITAS_KEY, []);
let logNotif         = lsGet(LOG_KEY, []);
let todosClientes    = [];
let todasSimulaciones= [];
let simSeleccionada  = null;
let diaSeleccionado  = null;
let calMes           = new Date();
let telefonoAdmin    = '';

// ======================================================
// UTILS
// ======================================================
function lsGet(k,def){try{return JSON.parse(localStorage.getItem(k))??def}catch{return def}}
function lsSet(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch{}}

function fmt(n){
  if(n===null||n===undefined||n==='') return '‚Äî';
  return '$'+Number(n).toLocaleString('es-MX',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function fmtFecha(s){
  if(!s) return '‚Äî';
  const d=new Date(s);
  if(isNaN(d)) return s;
  return d.toLocaleString('es-MX',{dateStyle:'medium',timeStyle:'short'});
}
function fechaAhora(){
  const n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());
  return n.toISOString().slice(0,16);
}
function genId(){
  return 'CIT-'+Date.now().toString(36).toUpperCase()+'-'+Math.random().toString(36).slice(2,6).toUpperCase();
}
function formatTelCliente(tel){
  const t=String(tel||'').replace(/\D/g,'');
  return t.length===10?'52'+t:t;
}
function abrirWACliente(tel,msg){
  const n=formatTelCliente(tel);
  if(!n){toast('Sin n√∫mero de tel√©fono','err');return;}
  window.open(`https://wa.me/${n}?text=${encodeURIComponent(msg)}`,'_blank');
}

// BADGE
function badge(estado){
  const m={
    'Pendiente': ['badge-p','‚è≥'],
    'Confirmada':['badge-ok','‚úÖ'],
    'Realizada': ['badge-az','üéØ'],
    'Cancelada': ['badge-rd','‚ùå'],
    'Activo':    ['badge-ok','‚úÖ'],
    'Inactivo':  ['badge-rd','‚ùå'],
    'Completo':  ['badge-ok','‚úÖ'],
    'Nuevo':     ['badge-p','‚ö†Ô∏è'],
  };
  const [cls,ico]=m[estado]||['badge-p','‚è≥'];
  return `<span class="badge ${cls}">${ico} ${estado}</span>`;
}

// TOAST
function toast(msg,tipo='ok',dur=3500){
  const c=document.getElementById('toast-container');
  const t=document.createElement('div');
  const ico=tipo==='ok'?'‚úÖ':tipo==='err'?'‚ùå':'‚ÑπÔ∏è';
  t.className=`toast ${tipo}`;
  t.innerHTML=`<span>${ico}</span><span>${msg}</span>`;
  c.appendChild(t);
  setTimeout(()=>t.style.opacity='0',dur-400);
  setTimeout(()=>t.remove(),dur);
}

// ======================================================
// TEL√âFONO ADMIN
// ======================================================
async function cargarTelefonoAdmin(){
  try{
    const r=await fetch(`${GAS_URL}?tipo=telefonoadmin`,{redirect:'follow'});
    const d=await r.json();
    if(d?.success&&d.data?.telefono){
      telefonoAdmin=String(d.data.telefono).replace(/\D/g,'');
    }
  }catch(e){}
}

// ======================================================
// FETCH GAS
// ======================================================
async function fetchGAS(tipo){
  try{
    const r=await fetch(`${GAS_URL}?tipo=${tipo}`,{redirect:'follow'});
    return await r.json();
  }catch(e){return null;}
}

// ======================================================
// TABS
// ======================================================
function cambiarTab(id,btn){
  document.querySelectorAll('.seccion').forEach(s=>s.classList.remove('visible'));
  document.querySelectorAll('.nav-item,.desktop-tab-btn').forEach(b=>b.classList.remove('activo'));
  document.getElementById('tab-'+id).classList.add('visible');
  // marcar activo en ambas navs
  document.querySelectorAll(`[data-tab="${id}"],.desktop-tab-btn`).forEach(b=>{
    if(b===btn||b.getAttribute('data-tab')===id||b.textContent.toLowerCase().includes(id.slice(0,4)))
      b.classList.add('activo');
  });
  btn.classList.add('activo');
  if(id==='consultar') cargarCitas();
  if(id==='calendario') renderCalendario();
  if(id==='notificaciones') actualizarPlantilla();
  if(id==='simulaciones'&&!todasSimulaciones.length) cargarSimulaciones();
}

// ======================================================
// TAB SIMULACIONES ‚Äî LISTA TIPO CARD
// ======================================================
async function cargarSimulaciones(){
  const list=document.getElementById('sim-card-list');
  list.innerHTML=`<div class="empty"><div class="spinner"></div><p style="margin-top:12px">Cargando...</p></div>`;

  const datos=await fetchGAS('simulaciones');

  if(!datos||!datos.success){
    const datosC=await fetchGAS('clientes');
    if(!datosC?.success){
      list.innerHTML=`<div class="empty"><div class="ico">‚ö†Ô∏è</div><p>No se pudo conectar</p></div>`;
      return;
    }
    const clientes=datosC.data?.clientes||[];
    todasSimulaciones=clientes.map(c=>({
      id:c.idCliente,idCliente:c.idCliente,
      fechaHora:c.ultimaInteraccion||c.fechaRegistro,
      nombre:c.nombreCliente,telefono:c.telefono,correo:c.correo,
      ubicacion:c.ubicacion,capital:'',dias:'',interesPorc:'',
      interesTotal:'',total:'',pagoDiario:'',
      estado:String(c.estado||'').replace(/[‚úÖ‚ùå‚ö†Ô∏è]\s*/,'')||'Activo',
      notas:`${c.cantidadSimulaciones||0} sims registradas`,_esCliente:true
    }));
    toast(`${clientes.length} clientes cargados`,'inf',4000);
  }else{
    todasSimulaciones=(datos.data?.simulaciones||[]).map(s=>({
      id:s[0],idCliente:s[1],fechaHora:s[2],nombre:s[3],telefono:s[4],
      capital:s[5],dias:s[6],interesPorc:s[7],interesTotal:s[8],
      total:s[9],pagoDiario:s[10],latitud:s[11],longitud:s[12],
      ubicacion:s[13],estado:String(s[17]||'').replace(/[‚úÖ‚ùå‚ö†Ô∏è]\s*/,''),
      notas:s[18],correo:s[19],
    }));
  }
  actualizarStatsSims();
  renderSimCards(todasSimulaciones);
}

function actualizarStatsSims(){
  const total=todasSimulaciones.length;
  const completo=todasSimulaciones.filter(s=>s.estado==='Completo'||s.estado==='Activo').length;
  const nuevo=todasSimulaciones.filter(s=>s.estado==='Nuevo').length;
  const conCita=todasSimulaciones.filter(s=>citasLocales.some(c=>c.idCliente===s.idCliente||c.simId===s.id)).length;
  document.getElementById('sim-stat-total').textContent=total;
  document.getElementById('sim-stat-completo').textContent=completo;
  document.getElementById('sim-stat-nuevo').textContent=nuevo;
  document.getElementById('sim-stat-agendadas').textContent=conCita;
}

function filtrarSimulaciones(){
  const q=document.getElementById('filtro-sims').value.toLowerCase();
  const est=document.getElementById('filtro-sim-estado').value;
  renderSimCards(todasSimulaciones.filter(s=>{
    const txt=`${s.id} ${s.nombre} ${s.telefono} ${s.idCliente} ${s.correo}`.toLowerCase();
    return(!q||txt.includes(q))&&(!est||s.estado===est);
  }));
}

function renderSimCards(lista){
  const list=document.getElementById('sim-card-list');
  if(!lista.length){
    list.innerHTML=`<div class="empty"><div class="ico">üì≠</div><p>Sin resultados</p></div>`;
    return;
  }
  const cabecera=`
    <div class="sim-list-head">
      <span>Nombre / Tel</span>
      <span>Capital</span>
      <span>Diario</span>
      <span>Plazo</span>
      <span style="text-align:right">Estado</span>
    </div>`;
  const filas=lista.map(s=>{
    const tieneCita=citasLocales.some(c=>c.idCliente===s.idCliente||c.simId===s.id);
    const est=s.estado||'‚Äî';
    return `
    <div class="sim-card-item" onclick="abrirModalSim('${s.id}')">
      <div>
        <div class="sc-nombre">${s.nombre||'Sin nombre'}</div>
        <div class="sc-sub">üìû ${s.telefono||'‚Äî'}</div>
      </div>
      <div class="sc-val verde">${s.capital?fmt(s.capital):'‚Äî'}</div>
      <div class="sc-val amarillo">${s.pagoDiario?fmt(s.pagoDiario):'‚Äî'}</div>
      <div class="sc-val gris">${s.dias?s.dias+'d':'‚Äî'}</div>
      <div class="sc-badge">
        ${badge(est)}
        ${tieneCita?`<span class="badge badge-az" style="font-size:.55rem;padding:2px 5px">üìÖ</span>`:''}
      </div>
    </div>`;
  }).join('');
  list.innerHTML=cabecera+filas;
}

// ======================================================
// MODAL SIMULACI√ìN ‚Äî POPUP AL HACER CLICK
// ======================================================
function abrirModalSim(id){
  const s=todasSimulaciones.find(x=>x.id===id);
  if(!s) return;
  simSeleccionada=s;

  document.getElementById('modal-sim-titulo').textContent=`üí∞ ${s.nombre||'Simulaci√≥n'}`;

  document.getElementById('modal-sim-body').innerHTML=`
    <!-- Monto destacado -->
    <div class="monto-grande">${s.total?fmt(s.total):'‚Äî'}</div>
    <div class="monto-sub">Total a pagar</div>

    <div class="monto-row">
      <div class="monto-chip">
        <div class="mc-val" style="color:var(--v)">${s.capital?fmt(s.capital):'‚Äî'}</div>
        <div class="mc-lbl">Capital</div>
      </div>
      <div class="monto-chip">
        <div class="mc-val" style="color:var(--am)">${s.pagoDiario?fmt(s.pagoDiario):'‚Äî'}</div>
        <div class="mc-lbl">Pago diario</div>
      </div>
      <div class="monto-chip">
        <div class="mc-val">${s.dias?s.dias+' d√≠as':'‚Äî'}</div>
        <div class="mc-lbl">Plazo</div>
      </div>
      <div class="monto-chip">
        <div class="mc-val">${s.interesPorc?s.interesPorc+'%':'‚Äî'}</div>
        <div class="mc-lbl">Inter√©s</div>
      </div>
    </div>

    <div class="sep"></div>

    <!-- Datos del cliente -->
    <div style="font-size:.7rem;font-weight:700;color:var(--v);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">üë§ Cliente</div>
    <div class="info-box">
      <div class="info-row"><span class="ik">üÜî ID Sim.</span><span class="iv"><span class="id-tag">${s.id}</span></span></div>
      <div class="info-row"><span class="ik">üë§ Nombre</span><span class="iv">${s.nombre||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìû Tel√©fono</span><span class="iv">${s.telefono||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìß Correo</span><span class="iv">${s.correo||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìç Direcci√≥n</span><span class="iv">${s.ubicacion||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìÖ Fecha</span><span class="iv">${s.fechaHora||'‚Äî'}</span></div>
      ${s.notas?`<div class="info-row"><span class="ik">üìù Notas</span><span class="iv">${s.notas}</span></div>`:''}
    </div>

    <!-- C√°lculo -->
    <div style="font-size:.7rem;font-weight:700;color:var(--v);text-transform:uppercase;letter-spacing:.06em;margin:12px 0 8px">üí∞ C√°lculo</div>
    <div class="calc-box">
      <div class="calc-row"><span class="ck">üíµ Capital</span><span class="cv">${s.capital?fmt(s.capital):'‚Äî'}</span></div>
      <div class="calc-row"><span class="ck">üìÖ Plazo</span><span class="cv">${s.dias?s.dias+' d√≠as':'‚Äî'}</span></div>
      <div class="calc-row"><span class="ck">üìà Inter√©s %</span><span class="cv">${s.interesPorc?s.interesPorc+'%':'‚Äî'}</span></div>
      <div class="calc-row"><span class="ck">üí∏ Inter√©s $</span><span class="cv">${s.interesTotal?fmt(s.interesTotal):'‚Äî'}</span></div>
      <div class="calc-row"><span class="ck">üóìÔ∏è Pago diario</span><span class="cv" style="font-size:1rem">${s.pagoDiario?fmt(s.pagoDiario):'‚Äî'}</span></div>
      <div class="calc-row"><span class="ck">üí∞ Total</span><span class="cv" style="font-size:1.05rem">${s.total?fmt(s.total):'‚Äî'}</span></div>
    </div>
  `;

  document.getElementById('modal-sim-footer').innerHTML=`
    <button class="btn btn-primary btn-full" onclick="usarSimEnAgendaDesdeModal()" style="margin-bottom:8px">
      üìÖ Agendar Entrevista
    </button>
    <div style="display:flex;gap:8px">
      <button class="btn btn-wa" onclick="waDesdeSimulacion()" style="flex:1">üì± WhatsApp</button>
      <button class="btn btn-ghost" onclick="cerrarModalSim()" style="flex:1">‚úï Cerrar</button>
    </div>
  `;

  document.getElementById('modal-sim').classList.add('open');
}

function cerrarModalSim(){
  document.getElementById('modal-sim').classList.remove('open');
}

function usarSimEnAgendaDesdeModal(){
  cerrarModalSim();
  usarSimEnAgenda();
}

function usarSimEnAgenda(){
  if(!simSeleccionada){toast('Selecciona una simulaci√≥n primero','err');return;}
  const s=simSeleccionada;

  // Ir a pesta√±a Agendar
  const btnAgendar=document.querySelector('.nav-item[data-tab="agendar"]')||document.querySelector('.desktop-tab-btn:nth-child(2)');
  if(btnAgendar) cambiarTab('agendar',btnAgendar);

  if(s.telefono) document.getElementById('buscar-tel').value=s.telefono;
  if(s.idCliente) document.getElementById('buscar-id').value=s.idCliente;

  const clienteSimulado={
    idCliente:s.idCliente||s.id,
    nombreCliente:s.nombre,telefono:s.telefono,correo:s.correo,
    ubicacion:s.ubicacion,cantidadSimulaciones:1,
    estado:s.estado||'Activo',fechaRegistro:s.fechaHora,ultimaInteraccion:s.fechaHora,
  };
  clienteActual=clienteSimulado;
  mostrarCliente(clienteSimulado);

  document.getElementById('cita-sim-id').value=s.id;

  const resumen=[
    `Simulaci√≥n: ${s.id}`,
    s.capital?`Capital: ${fmt(s.capital)}`:'',
    s.dias?`Plazo: ${s.dias} d√≠as`:'',
    s.interesPorc?`Inter√©s: ${s.interesPorc}%`:'',
    s.pagoDiario?`Pago diario: ${fmt(s.pagoDiario)}`:'',
    s.total?`Total: ${fmt(s.total)}`:'',
  ].filter(Boolean).join(' | ');
  document.getElementById('cita-notas').value=resumen;

  // Pre-llenar notif
  document.getElementById('notif-nombre').value=s.nombre||'';
  document.getElementById('notif-tel').value=s.telefono||'';
  document.getElementById('notif-email').value=s.correo||'';
  document.getElementById('notif-capital').value=s.capital||'';
  document.getElementById('notif-dias').value=s.dias||'';
  document.getElementById('notif-pago').value=s.pagoDiario||'';
  document.getElementById('notif-total').value=s.total||'';

  const manana=new Date();
  manana.setDate(manana.getDate()+1);manana.setHours(10,0,0,0);
  manana.setMinutes(manana.getMinutes()-manana.getTimezoneOffset());
  document.getElementById('cita-fecha').value=manana.toISOString().slice(0,16);

  toast(`‚úÖ Datos de ${s.nombre||'cliente'} cargados`,'ok');
  window.scrollTo({top:0,behavior:'smooth'});
}

function waDesdeSimulacion(){
  if(!simSeleccionada){toast('Selecciona una simulaci√≥n','err');return;}
  const s=simSeleccionada;
  const msg=[
    `üí∞ *RESULTADO DE SU SIMULACI√ìN ‚Äî SimPr√©stamo*`,``,
    `Hola *${s.nombre||'Cliente'}*, aqu√≠ el resumen de su c√°lculo:`,``,
    s.capital?`üíµ *Capital:* ${fmt(s.capital)}`:'',
    s.dias?`üìÖ *Plazo:* ${s.dias} d√≠as`:'',
    s.interesPorc?`üìà *Inter√©s:* ${s.interesPorc}%`:'',
    s.pagoDiario?`üóìÔ∏è *Pago diario:* ${fmt(s.pagoDiario)}`:'',
    s.total?`üí∏ *Total a pagar:* ${fmt(s.total)}`:'',``,
    `¬øLe interesa continuar? Le agendamos una entrevista sin costo.`,``,
    `_SimPr√©stamo ‚Äî ${new Date().toLocaleDateString('es-MX')}_`
  ].filter(Boolean).join('\n');
  abrirWACliente(s.telefono,msg);
  registrarLog('WhatsApp',`Resultado sim enviado a ${s.nombre}`,s.id);
  toast('üì± WhatsApp abierto','ok');
}

// ======================================================
// TAB AGENDAR
// ======================================================
async function buscarCliente(){
  const tel=document.getElementById('buscar-tel').value.trim();
  const id=document.getElementById('buscar-id').value.trim();
  if(!tel&&!id){toast('Ingresa tel√©fono o ID','inf');return;}

  const btn=event.target;btn.disabled=true;btn.textContent='Buscando...';
  toast('Conectando...','inf',2500);

  const datos=await fetchGAS('clientes');
  btn.disabled=false;btn.innerHTML='üîç Buscar Cliente';

  if(!datos?.success){toast('No se pudo conectar','err');return;}

  const clientes=datos.data?.clientes||[];
  let c=null;
  if(tel) c=clientes.find(cl=>String(cl.telefono).replace(/\D/g,'')===tel.replace(/\D/g,''));
  if(!c&&id) c=clientes.find(cl=>cl.idCliente===id);

  if(!c){toast('Cliente no encontrado','err');return;}
  clienteActual=c;
  mostrarCliente(c);
  toast('‚úÖ Cliente encontrado','ok');
}

function mostrarCliente(c){
  const estado=String(c.estado||'Activo').replace(/[‚úÖ‚ùå]\s*/,'');
  document.getElementById('cliente-info-box').innerHTML=`
    <div class="info-row"><span class="ik">üÜî ID</span><span class="iv"><span class="id-tag">${c.idCliente||'‚Äî'}</span></span></div>
    <div class="info-row"><span class="ik">üë§ Nombre</span><span class="iv">${c.nombreCliente||'‚Äî'}</span></div>
    <div class="info-row"><span class="ik">üìû Tel√©fono</span><span class="iv">${c.telefono||'‚Äî'}</span></div>
    <div class="info-row"><span class="ik">üìß Correo</span><span class="iv">${c.correo||'‚Äî'}</span></div>
    <div class="info-row"><span class="ik">üìä Sims</span><span class="iv">${c.cantidadSimulaciones||0}</span></div>
    <div class="info-row"><span class="ik">üîî Estado</span><span class="iv">${badge(estado)}</span></div>
  `;
  document.getElementById('resultado-cliente').style.display='block';
  document.getElementById('btn-wa-confirm').disabled=false;
  document.getElementById('cita-fecha').value=fechaAhora();

  const previas=citasLocales.filter(ct=>ct.idCliente===c.idCliente);
  if(previas.length){
    document.getElementById('citas-previas').style.display='block';
    document.getElementById('lista-citas-previas').innerHTML=previas.map(ct=>`
      <div class="calc-box" style="margin-bottom:8px">
        <div class="calc-row"><span class="ck">üìÖ</span><span class="cv">${fmtFecha(ct.fecha)}</span></div>
        <div class="calc-row"><span class="ck">Estado</span><span class="cv">${badge(ct.estado)}</span></div>
        <div class="calc-row"><span class="ck">Modalidad</span><span class="cv">${ct.modalidad||'‚Äî'}</span></div>
      </div>`).join('');
  }
  document.getElementById('notif-nombre').value=c.nombreCliente||'';
  document.getElementById('notif-tel').value=c.telefono||'';
  document.getElementById('notif-email').value=c.correo||'';
}

function limpiarCliente(){
  clienteActual=null;
  document.getElementById('resultado-cliente').style.display='none';
  document.getElementById('btn-wa-confirm').disabled=true;
  document.getElementById('citas-previas').style.display='none';
}
function limpiarBusqueda(){
  limpiarCliente();
  document.getElementById('buscar-tel').value='';
  document.getElementById('buscar-id').value='';
}
function limpiarFormCita(){
  ['cita-fecha','cita-lugar','cita-asesor','cita-notas','cita-sim-id'].forEach(id=>document.getElementById(id).value='');
}

function agendarCita(){
  const fecha=document.getElementById('cita-fecha').value;
  if(!fecha){toast('Selecciona fecha y hora','err');return;}
  if(!clienteActual){toast('Busca un cliente primero','err');return;}

  const cita={
    id:genId(),idCliente:clienteActual.idCliente,
    nombre:clienteActual.nombreCliente,telefono:clienteActual.telefono,
    correo:clienteActual.correo,ubicacion:clienteActual.ubicacion,
    fecha,
    modalidad:document.getElementById('cita-modalidad').value,
    duracion:document.getElementById('cita-duracion').value,
    lugar:document.getElementById('cita-lugar').value,
    asesor:document.getElementById('cita-asesor').value,
    notas:document.getElementById('cita-notas').value,
    simId:document.getElementById('cita-sim-id').value,
    estado:'Pendiente',creada:new Date().toISOString()
  };
  citasLocales.unshift(cita);
  lsSet(CITAS_KEY,citasLocales);
  toast('‚úÖ Cita agendada','ok');
  actualizarStats();
  document.getElementById('notif-fecha-cita').value=fecha;
  document.getElementById('notif-lugar').value=cita.lugar||'';
  registrarLog('Sistema',`Cita agendada para ${cita.nombre} ‚Äî ${fmtFecha(fecha)}`,cita.id);
}

function notificarWhatsApp(){
  if(!clienteActual){toast('Busca un cliente primero','err');return;}
  const fecha=document.getElementById('cita-fecha').value;
  const lugar=document.getElementById('cita-lugar').value;
  const mod=document.getElementById('cita-modalidad').value;
  const msg=[
    `‚úÖ *CONFIRMACI√ìN DE ENTREVISTA*`,``,
    `Hola *${clienteActual.nombreCliente}*, le confirmamos su cita con SimPr√©stamo.`,``,
    fecha?`üìÖ *Fecha:* ${fmtFecha(fecha)}`:'',
    lugar?`üìç *Lugar:* ${lugar}`:'',
    `üìã *Modalidad:* ${mod}`,``,
    `Documentos necesarios:`,
    `‚Ä¢ Identificaci√≥n oficial (INE)`,
    `‚Ä¢ Comprobante de domicilio reciente`,
    `‚Ä¢ Comprobante de ingresos`,``,
    `¬øAlguna duda? Responda este mensaje.`,``,
    `_SimPr√©stamo ‚Äî ${new Date().toLocaleDateString('es-MX')}_`
  ].filter(Boolean).join('\n');
  abrirWACliente(clienteActual.telefono,msg);
  registrarLog('WhatsApp',`Confirmaci√≥n enviada a ${clienteActual.nombreCliente}`,'agendar');
  toast('üì± WhatsApp abierto','ok');
}

// ======================================================
// TAB MIS CITAS
// ======================================================
function cargarCitas(){
  actualizarStats();
  renderListaCitas(citasLocales);
}
function actualizarStats(){
  document.getElementById('stat-total').textContent=citasLocales.length;
  document.getElementById('stat-pendientes').textContent=citasLocales.filter(c=>c.estado==='Pendiente').length;
  document.getElementById('stat-realizadas').textContent=citasLocales.filter(c=>c.estado==='Realizada').length;
  document.getElementById('stat-canceladas').textContent=citasLocales.filter(c=>c.estado==='Cancelada').length;
}

function renderListaCitas(lista){
  const div=document.getElementById('lista-citas');
  if(!lista.length){
    div.innerHTML=`<div class="empty"><div class="ico">üì≠</div><p>Sin citas. Ag√©ndalas en "Agendar".</p></div>`;
    return;
  }
  div.innerHTML=lista.map(c=>`
    <div class="cita-item" onclick="verCita('${c.id}')">
      <div class="cita-top">
        <div>
          <div class="cita-nombre">${c.nombre||'‚Äî'}</div>
          <div class="cita-meta">
            <span>üìÖ ${fmtFecha(c.fecha)}</span>
            <span>üìã ${c.modalidad||'‚Äî'}</span>
            ${c.asesor?`<span>üßë ${c.asesor}</span>`:''}
          </div>
        </div>
        ${badge(c.estado)}
      </div>
      <div class="cita-acciones" onclick="event.stopPropagation()">
        <button class="btn btn-primary btn-sm" onclick="cambiarEstado('${c.id}','Realizada')">üéØ</button>
        <button class="btn btn-wa btn-sm" onclick="waRapido('${c.id}')">üì±</button>
        <button class="btn btn-rojo btn-sm" onclick="cambiarEstado('${c.id}','Cancelada')">‚ùå</button>
      </div>
    </div>
  `).join('');
}

function filtrarCitas(){
  const q=document.getElementById('filtro-citas').value.toLowerCase();
  const est=document.getElementById('filtro-estado').value;
  renderListaCitas(citasLocales.filter(c=>{
    const txt=`${c.nombre} ${c.telefono} ${c.fecha} ${c.asesor}`.toLowerCase();
    return(!q||txt.includes(q))&&(!est||c.estado===est);
  }));
}

function cambiarEstado(id,nuevoEstado){
  const idx=citasLocales.findIndex(c=>c.id===id);
  if(idx<0) return;
  citasLocales[idx].estado=nuevoEstado;
  lsSet(CITAS_KEY,citasLocales);
  cargarCitas();renderCalendario();
  toast(`Estado ‚Üí ${nuevoEstado}`,'ok');
}

function verCita(id){
  const c=citasLocales.find(ct=>ct.id===id);
  if(!c) return;
  document.getElementById('modal-cita-body').innerHTML=`
    <div class="info-box">
      <div class="info-row"><span class="ik">üÜî ID</span><span class="iv"><span class="id-tag">${c.id}</span></span></div>
      <div class="info-row"><span class="ik">üë§ Cliente</span><span class="iv">${c.nombre}</span></div>
      <div class="info-row"><span class="ik">üìû Tel√©fono</span><span class="iv">${c.telefono||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìß Correo</span><span class="iv">${c.correo||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìÖ Fecha</span><span class="iv">${fmtFecha(c.fecha)}</span></div>
      <div class="info-row"><span class="ik">‚è± Duraci√≥n</span><span class="iv">${c.duracion||30} min</span></div>
      <div class="info-row"><span class="ik">üìã Modalidad</span><span class="iv">${c.modalidad||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìç Lugar</span><span class="iv">${c.lugar||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üßë Asesor</span><span class="iv">${c.asesor||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üîî Estado</span><span class="iv">${badge(c.estado)}</span></div>
      ${c.simId?`<div class="info-row"><span class="ik">üÜî Sim</span><span class="iv"><span class="id-tag">${c.simId}</span></span></div>`:''}
      ${c.notas?`<div class="info-row"><span class="ik">üìù Notas</span><span class="iv">${c.notas}</span></div>`:''}
    </div>
    <div style="font-size:.7rem;font-weight:700;color:var(--v);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">Cambiar estado</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <button class="btn btn-ghost btn-sm" onclick="cambiarEstado('${c.id}','Pendiente');cerrarModalCita()">‚è≥ Pendiente</button>
      <button class="btn btn-primary btn-sm" onclick="cambiarEstado('${c.id}','Confirmada');cerrarModalCita()">‚úÖ Confirmada</button>
      <button class="btn btn-azul btn-sm" onclick="cambiarEstado('${c.id}','Realizada');cerrarModalCita()">üéØ Realizada</button>
      <button class="btn btn-rojo btn-sm" onclick="cambiarEstado('${c.id}','Cancelada');cerrarModalCita()">‚ùå Cancelada</button>
    </div>
  `;
  document.getElementById('modal-cita-footer').innerHTML=`
    <div style="display:flex;gap:8px">
      <button class="btn btn-wa" onclick="waRapido('${c.id}')" style="flex:1">üì± WA Cliente</button>
      <button class="btn btn-ghost" onclick="reprogramar('${c.id}')" style="flex:1">üìÖ Reprogramar</button>
    </div>
  `;
  document.getElementById('modal-cita').classList.add('open');
}

function cerrarModalCita(){document.getElementById('modal-cita').classList.remove('open')}

function reprogramar(id){
  const c=citasLocales.find(ct=>ct.id===id);
  if(!c) return;
  const nueva=prompt('Nueva fecha (YYYY-MM-DDTHH:MM):\nEj: 2026-03-15T10:00');
  if(!nueva) return;
  const idx=citasLocales.findIndex(ct=>ct.id===id);
  citasLocales[idx].fecha=nueva;citasLocales[idx].estado='Pendiente';
  lsSet(CITAS_KEY,citasLocales);
  cargarCitas();renderCalendario();cerrarModalCita();
  toast('‚úÖ Cita reprogramada','ok');
  const msg=[
    `üìÖ *CITA REPROGRAMADA*`,``,
    `Hola *${c.nombre}*, su entrevista fue reprogramada.`,``,
    `üìÖ *Nueva fecha:* ${fmtFecha(nueva)}`,
    c.lugar?`üìç *Lugar:* ${c.lugar}`:'',``,
    `Por favor confirme su asistencia.`,`_SimPr√©stamo_`
  ].filter(Boolean).join('\n');
  if(confirm('¬øNotificar al cliente por WhatsApp?')) abrirWACliente(c.telefono,msg);
}

function waRapido(id){
  const c=citasLocales.find(ct=>ct.id===id);
  if(!c) return;
  const msg=[
    `‚úÖ *RECORDATORIO ‚Äî SimPr√©stamo*`,``,
    `Hola *${c.nombre}*, le recordamos su cita.`,``,
    `üìÖ *Fecha:* ${fmtFecha(c.fecha)}`,
    c.lugar?`üìç *Lugar:* ${c.lugar}`:'',
    `üìã *Modalidad:* ${c.modalidad}`,``,
    `¬øAlguna duda? Cont√°ctenos.`,
    `_SimPr√©stamo ‚Äî ${new Date().toLocaleDateString('es-MX')}_`
  ].filter(Boolean).join('\n');
  abrirWACliente(c.telefono,msg);
  registrarLog('WhatsApp',`Recordatorio enviado a ${c.nombre}`,c.id);
}

function exportarCSV(){
  const cab=['ID','Cliente','Tel√©fono','Correo','Fecha','Modalidad','Lugar','Asesor','Estado','Notas','SimID'];
  const rows=citasLocales.map(c=>[c.id,c.nombre,c.telefono,c.correo,fmtFecha(c.fecha),c.modalidad,c.lugar,c.asesor,c.estado,c.notas,c.simId].map(v=>`"${(v||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv=[cab.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download=`Citas_${new Date().toLocaleDateString('es-MX').replace(/\//g,'-')}.csv`;
  a.click();toast('‚úÖ CSV exportado','ok');
}

// ======================================================
// CALENDARIO
// ======================================================
function renderCalendario(){
  const y=calMes.getFullYear(),m=calMes.getMonth();
  const mN=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  document.getElementById('cal-mes-titulo').textContent=`${mN[m]} ${y}`;
  const diasMes=new Date(y,m+1,0).getDate();
  const offset=(new Date(y,m,1).getDay()+6)%7;
  const diasConCitas=new Set(citasLocales.filter(c=>{const d=new Date(c.fecha);return d.getFullYear()===y&&d.getMonth()===m&&c.estado!=='Cancelada';}).map(c=>new Date(c.fecha).getDate()));
  const hoy=new Date();
  let html=['Lu','Ma','Mi','Ju','Vi','S√°','Do'].map(d=>`<div class="cal-day-name">${d}</div>`).join('');
  for(let i=0;i<offset;i++) html+=`<div class="cal-day vacio"></div>`;
  for(let d=1;d<=diasMes;d++){
    const esHoy=hoy.getFullYear()===y&&hoy.getMonth()===m&&hoy.getDate()===d;
    const esSel=diaSeleccionado&&diaSeleccionado.getFullYear()===y&&diaSeleccionado.getMonth()===m&&diaSeleccionado.getDate()===d;
    const conCitas=diasConCitas.has(d);
    html+=`<div class="cal-day${esHoy?' hoy':''}${esSel?' seleccionado':''}${conCitas?' con-citas':''}" onclick="seleccionarDia(${y},${m},${d})">${d}</div>`;
  }
  document.getElementById('cal-grid').innerHTML=html;
}
function navMes(dir){calMes.setMonth(calMes.getMonth()+dir);renderCalendario();}
function seleccionarDia(y,m,d){
  diaSeleccionado=new Date(y,m,d);renderCalendario();
  const citas=citasLocales.filter(c=>{const cd=new Date(c.fecha);return cd.getFullYear()===y&&cd.getMonth()===m&&cd.getDate()===d;});
  const div=document.getElementById('citas-dia');
  if(!citas.length){
    div.innerHTML=`<div class="empty"><div class="ico">üì≠</div><p>Sin citas para el ${d}/${m+1}/${y}</p><button class="btn btn-azul btn-sm" style="margin-top:10px" onclick="irAAgendarFecha(${y},${m},${d})">+ Agendar</button></div>`;
    return;
  }
  div.innerHTML=citas.map(c=>`
    <div class="cita-item" onclick="verCita('${c.id}')">
      <div class="cita-top">
        <div><div class="cita-nombre">${c.nombre}</div>
        <div class="cita-meta"><span>‚è∞ ${new Date(c.fecha).toLocaleTimeString('es-MX',{hour:'2-digit',minute:'2-digit'})}</span><span>${c.modalidad}</span></div></div>
        ${badge(c.estado)}
      </div>
    </div>`).join('');
}
function irAAgendarFecha(y,m,d){
  const btn=document.querySelector('.nav-item[data-tab="agendar"]');
  if(btn) cambiarTab('agendar',btn);
  document.getElementById('cita-fecha').value=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}T09:00`;
}

// ======================================================
// FICHA CLIENTE
// ======================================================
async function buscarFichaCliente(){
  const q=document.getElementById('ficha-buscar').value.trim();
  if(!q){toast('Ingresa tel√©fono o ID','inf');return;}
  const datos=await fetchGAS('clientes');
  if(!datos?.success){toast('Error de conexi√≥n','err');return;}
  const c=datos.data?.clientes?.find(cl=>String(cl.telefono).replace(/\D/g,'')=== q.replace(/\D/g,'')||cl.idCliente===q);
  if(!c){toast('Cliente no encontrado','err');return;}
  mostrarFichaCliente(c);
}
async function cargarTodosClientes(){
  toast('Cargando...','inf',2000);
  const datos=await fetchGAS('clientes');
  if(!datos?.success){toast('Error','err');return;}
  todosClientes=datos.data?.clientes||[];
  document.getElementById('todos-clientes').style.display='block';
  document.getElementById('ficha-resultado').style.display='none';
  renderListaClientes(todosClientes);
  toast(`${todosClientes.length} clientes`,'ok');
}
function filtrarClientes(){
  const q=document.getElementById('filtro-clientes').value.toLowerCase();
  renderListaClientes(todosClientes.filter(c=>`${c.nombreCliente} ${c.telefono} ${c.correo} ${c.idCliente}`.toLowerCase().includes(q)));
}
function renderListaClientes(lista){
  const div=document.getElementById('lista-clientes');
  if(!lista.length){div.innerHTML=`<div class="empty"><div class="ico">üì≠</div><p>Sin resultados</p></div>`;return;}
  div.innerHTML=lista.map(c=>`
    <div class="cita-item" onclick='mostrarFichaClienteStr(${JSON.stringify(JSON.stringify(c))})'>
      <div class="cita-top">
        <div>
          <div class="cita-nombre">${c.nombreCliente||'‚Äî'}</div>
          <div class="cita-meta"><span>üìû ${c.telefono||'‚Äî'}</span><span>üìä ${c.cantidadSimulaciones||0} sims</span></div>
        </div>
        ${badge(String(c.estado||'Activo').replace(/[‚úÖ‚ùå]\s*/,''))}
      </div>
    </div>`).join('');
}
function mostrarFichaClienteStr(str){mostrarFichaCliente(JSON.parse(str));}
function mostrarFichaCliente(c){
  clienteActual=c;
  document.getElementById('todos-clientes').style.display='none';
  document.getElementById('ficha-resultado').style.display='block';
  const estado=String(c.estado||'Activo').replace(/[‚úÖ‚ùå]\s*/,'');
  document.getElementById('ficha-datos').innerHTML=`
    <div class="info-box">
      <div class="info-row"><span class="ik">üÜî ID</span><span class="iv"><span class="id-tag">${c.idCliente}</span></span></div>
      <div class="info-row"><span class="ik">üë§ Nombre</span><span class="iv">${c.nombreCliente||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìû Tel</span><span class="iv">${c.telefono||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìß Correo</span><span class="iv">${c.correo||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìç Ubicaci√≥n</span><span class="iv">${c.ubicacion||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üìä Sims</span><span class="iv">${c.cantidadSimulaciones||0}</span></div>
      <div class="info-row"><span class="ik">üìÖ Registrado</span><span class="iv">${c.fechaRegistro||'‚Äî'}</span></div>
      <div class="info-row"><span class="ik">üîî Estado</span><span class="iv">${badge(estado)}</span></div>
    </div>`;
  document.getElementById('btn-wa-ficha').onclick=()=>abrirWACliente(c.telefono,'');
  const citas=citasLocales.filter(ct=>ct.idCliente===c.idCliente);
  document.getElementById('ficha-citas').innerHTML=!citas.length
    ?`<div class="empty"><div class="ico">üì≠</div><p>Sin citas</p></div>`
    :citas.map(ct=>`
      <div class="cita-item" onclick="verCita('${ct.id}')">
        <div class="cita-top">
          <div><div class="cita-nombre">${fmtFecha(ct.fecha)}</div>
          <div class="cita-meta"><span>${ct.modalidad}</span>${ct.asesor?`<span>${ct.asesor}</span>`:''}</div></div>
          ${badge(ct.estado)}
        </div>
      </div>`).join('');
  document.getElementById('ficha-simulaciones').innerHTML=`
    <div class="alerta alerta-info" style="margin-top:0">
      <span>‚ÑπÔ∏è</span>
      <div>${c.cantidadSimulaciones||0} simulaciones registradas.<br>
      <small>Filtra por ID: <strong>${c.idCliente}</strong></small></div>
    </div>`;
  toast('Ficha cargada','ok');
}
function agendarDesdeficha(){
  if(!clienteActual) return;
  const btn=document.querySelector('.nav-item[data-tab="agendar"]');
  if(btn) cambiarTab('agendar',btn);
  document.getElementById('buscar-tel').value=clienteActual.telefono||'';
  mostrarCliente(clienteActual);
  window.scrollTo({top:0,behavior:'smooth'});
}

// ======================================================
// NOTIFICACIONES
// ======================================================
function actualizarPlantilla(){
  const tipo=document.getElementById('notif-tipo').value;
  if(tipo==='personalizado') return;
  const nombre=document.getElementById('notif-nombre').value||'Cliente';
  const capital=document.getElementById('notif-capital').value;
  const dias=document.getElementById('notif-dias').value;
  const pago=document.getElementById('notif-pago').value;
  const total=document.getElementById('notif-total').value;
  const fecha=document.getElementById('notif-fecha-cita').value;
  const lugar=document.getElementById('notif-lugar').value;
  let msg='';
  if(tipo==='confirmacion') msg=[`‚úÖ *CONFIRMACI√ìN DE ENTREVISTA*`,``,`Hola *${nombre}*, su cita con SimPr√©stamo est√° confirmada.`,``,fecha?`üìÖ *Fecha:* ${fmtFecha(fecha)}`:'',lugar?`üìç *Lugar:* ${lugar}`:'',``,`Documentos:`,`‚Ä¢ INE vigente`,`‚Ä¢ Comprobante de domicilio`,`‚Ä¢ Comprobante de ingresos`,``,`¬øAlguna duda? Responda este mensaje.`,``,`_SimPr√©stamo ‚Äî ${new Date().toLocaleDateString('es-MX')}_`].filter(Boolean).join('\n');
  else if(tipo==='recordatorio') msg=[`‚è∞ *RECORDATORIO ‚Äî ENTREVISTA MA√ëANA*`,``,`Hola *${nombre}*, le recordamos su cita de ma√±ana.`,``,fecha?`üìÖ *Fecha:* ${fmtFecha(fecha)}`:'',lugar?`üìç *Lugar:* ${lugar}`:'',``,`No olvide sus documentos (INE, comprobante domicilio, ingresos).`,``,`_SimPr√©stamo_`].filter(Boolean).join('\n');
  else if(tipo==='resultado') msg=[`üí∞ *RESULTADO DE SU SIMULACI√ìN*`,``,`Hola *${nombre}*, aqu√≠ su resumen:`,``,capital?`üíµ *Capital:* ${fmt(capital)}`:'',dias?`üìÖ *Plazo:* ${dias} d√≠as`:'',pago?`üóìÔ∏è *Pago diario:* ${fmt(pago)}`:'',total?`üí∏ *Total:* ${fmt(total)}`:'',``,`¬øLe interesa continuar? Agendemos una entrevista.`,``,fecha?`üìÖ *Cita propuesta:* ${fmtFecha(fecha)}`:'',lugar?`üìç *Lugar:* ${lugar}`:'',``,`_SimPr√©stamo ‚Äî ${new Date().toLocaleDateString('es-MX')}_`].filter(Boolean).join('\n');
  else if(tipo==='reprogramar') msg=[`üìÖ *CITA REPROGRAMADA*`,``,`Hola *${nombre}*, su entrevista fue reprogramada.`,``,fecha?`üìÖ *Nueva fecha:* ${fmtFecha(fecha)}`:'',lugar?`üìç *Lugar:* ${lugar}`:'',``,`Por favor confirme su asistencia.`,``,`_SimPr√©stamo_`].filter(Boolean).join('\n');
  document.getElementById('notif-preview').value=msg;
  const mostrarSim=['resultado','confirmacion','reprogramar'].includes(tipo);
  document.getElementById('notif-sim-datos').style.display=mostrarSim?'block':'none';
}
function enviarNotifWA(){
  const tel=document.getElementById('notif-tel').value.trim();
  const msg=document.getElementById('notif-preview').value;
  const nombre=document.getElementById('notif-nombre').value;
  if(!tel){toast('Ingresa el tel√©fono','err');return;}
  if(!msg){toast('El mensaje est√° vac√≠o','err');return;}
  abrirWACliente(tel,msg);
  registrarLog('WhatsApp',`Mensaje a ${nombre||tel}`,'manual');
  toast('üì± WhatsApp abierto','ok');
}
function enviarNotifEmail(){
  const email=document.getElementById('notif-email').value.trim();
  const nombre=document.getElementById('notif-nombre').value;
  const msg=document.getElementById('notif-preview').value;
  if(!email){toast('Ingresa el correo','err');return;}
  window.open(`mailto:${email}?subject=${encodeURIComponent('SimPr√©stamo ‚Äî Info para '+nombre)}&body=${encodeURIComponent(msg)}`,'_blank');
  registrarLog('Email',`Email a ${nombre||email}`,'manual');
  toast('üìß Correo abierto','ok');
}
function registrarLog(canal,desc,ref){
  logNotif.unshift({fecha:new Date().toISOString(),canal,desc,ref});
  lsSet(LOG_KEY,logNotif.slice(0,50));renderLog();
}
function renderLog(){
  const div=document.getElementById('log-notificaciones');
  if(!logNotif.length){div.innerHTML=`<div class="empty"><div class="ico">üì≠</div><p>Sin notificaciones</p></div>`;return;}
  div.innerHTML=logNotif.slice(0,20).map(l=>`
    <div class="calc-box" style="margin-bottom:8px;padding:10px 14px">
      <div class="calc-row"><span class="ck">${l.canal==='WhatsApp'?'üì±':'üìß'} ${l.canal}</span><span class="cv" style="font-size:.72rem;color:var(--tx)">${new Date(l.fecha).toLocaleString('es-MX')}</span></div>
      <div style="font-size:.82rem;color:var(--tx);margin-top:4px">${l.desc}</div>
    </div>`).join('');
}

// ======================================================
// CERRAR MODALES CON CLICK FUERA
// ======================================================
window.addEventListener('click',e=>{
  if(e.target===document.getElementById('modal-sim')) cerrarModalSim();
  if(e.target===document.getElementById('modal-cita')) cerrarModalCita();
});

// Swipe down para cerrar modales
['modal-sim','modal-cita'].forEach(id=>{
  const el=document.getElementById(id);
  let startY=0;
  el.querySelector('.modal').addEventListener('touchstart',e=>{startY=e.touches[0].clientY;},{passive:true});
  el.querySelector('.modal').addEventListener('touchend',e=>{
    const dy=e.changedTouches[0].clientY-startY;
    if(dy>80) id==='modal-sim'?cerrarModalSim():cerrarModalCita();
  },{passive:true});
});

// ======================================================
// INIT
// ======================================================
actualizarPlantilla();
renderLog();
actualizarStats();
renderCalendario();
document.getElementById('cita-fecha').min=fechaAhora();
document.getElementById('notif-fecha-cita').min=fechaAhora();
cargarTelefonoAdmin();
console.log('‚úÖ SimPr√©stamo Agenda v3 ‚Äî mobile-first cargada');
</script>
</body>
</html>
